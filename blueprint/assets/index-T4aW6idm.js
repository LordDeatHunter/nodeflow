(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=o(s);fetch(s.href,i)}})();const Pt=(t,e)=>t===e,J=Symbol("solid-proxy"),Ke=Symbol("solid-track"),be={equals:Pt};let rt=lt;const Q=1,Ie=2,ct={owned:null,cleanups:null,context:null,owner:null};var S=null;let Le=null,Et=null,C=null,M=null,Y=null,Te=0;function De(t,e){const o=C,n=S,s=t.length===0,i=e===void 0?n:e,r=s?ct:{owned:null,cleanups:null,context:i?i.context:null,owner:i},c=s?t:()=>t(()=>V(()=>pe(r)));S=r,C=null;try{return le(c,!0)}finally{C=o,S=n}}function de(t,e){e=e?Object.assign({},be,e):be;const o={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=s=>(typeof s=="function"&&(s=s(o.value)),dt(o,s));return[at.bind(o),n]}function x(t,e,o){const n=We(t,e,!1,Q);me(n)}function fe(t,e,o){rt=zt;const n=We(t,e,!1,Q);n.user=!0,Y?Y.push(n):me(n)}function L(t,e,o){o=o?Object.assign({},be,o):be;const n=We(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=o.equals||void 0,me(n),at.bind(n)}function Ne(t){return le(t,!1)}function V(t){if(C===null)return t();const e=C;C=null;try{return t()}finally{C=e}}function Mt(t){fe(()=>V(t))}function Ue(t){return S===null||(S.cleanups===null?S.cleanups=[t]:S.cleanups.push(t)),t}function Pe(){return C}function at(){if(this.sources&&this.state)if(this.state===Q)me(this);else{const t=M;M=null,le(()=>Me(this),!1),M=t}if(C){const t=this.observers?this.observers.length:0;C.sources?(C.sources.push(this),C.sourceSlots.push(t)):(C.sources=[this],C.sourceSlots=[t]),this.observers?(this.observers.push(C),this.observerSlots.push(C.sources.length-1)):(this.observers=[C],this.observerSlots=[C.sources.length-1])}return this.value}function dt(t,e,o){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&le(()=>{for(let s=0;s<t.observers.length;s+=1){const i=t.observers[s],r=Le&&Le.running;r&&Le.disposed.has(i),(r?!i.tState:!i.state)&&(i.pure?M.push(i):Y.push(i),i.observers&&ut(i)),r||(i.state=Q)}if(M.length>1e6)throw M=[],new Error},!1)),e}function me(t){if(!t.fn)return;pe(t);const e=Te;xt(t,t.value,e)}function xt(t,e,o){let n;const s=S,i=C;C=S=t;try{n=t.fn(e)}catch(r){return t.pure&&(t.state=Q,t.owned&&t.owned.forEach(pe),t.owned=null),t.updatedAt=o+1,ht(r)}finally{C=i,S=s}(!t.updatedAt||t.updatedAt<=o)&&(t.updatedAt!=null&&"observers"in t?dt(t,n):t.value=n,t.updatedAt=o)}function We(t,e,o,n=Q,s){const i={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:S,context:S?S.context:null,pure:o};return S===null||S!==ct&&(S.owned?S.owned.push(i):S.owned=[i]),i}function Ee(t){if(t.state===0)return;if(t.state===Ie)return Me(t);if(t.suspense&&V(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<Te);)t.state&&e.push(t);for(let o=e.length-1;o>=0;o--)if(t=e[o],t.state===Q)me(t);else if(t.state===Ie){const n=M;M=null,le(()=>Me(t,e[0]),!1),M=n}}function le(t,e){if(M)return t();let o=!1;e||(M=[]),Y?o=!0:Y=[],Te++;try{const n=t();return At(o),n}catch(n){o||(Y=null),M=null,ht(n)}}function At(t){if(M&&(lt(M),M=null),t)return;const e=Y;Y=null,e.length&&le(()=>rt(e),!1)}function lt(t){for(let e=0;e<t.length;e++)Ee(t[e])}function zt(t){let e,o=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[o++]=n:Ee(n)}for(e=0;e<o;e++)Ee(t[e])}function Me(t,e){t.state=0;for(let o=0;o<t.sources.length;o+=1){const n=t.sources[o];if(n.sources){const s=n.state;s===Q?n!==e&&(!n.updatedAt||n.updatedAt<Te)&&Ee(n):s===Ie&&Me(n,e)}}}function ut(t){for(let e=0;e<t.observers.length;e+=1){const o=t.observers[e];o.state||(o.state=Ie,o.pure?M.push(o):Y.push(o),o.observers&&ut(o))}}function pe(t){let e;if(t.sources)for(;t.sources.length;){const o=t.sources.pop(),n=t.sourceSlots.pop(),s=o.observers;if(s&&s.length){const i=s.pop(),r=o.observerSlots.pop();n<s.length&&(i.sourceSlots[r]=n,s[n]=i,o.observerSlots[n]=r)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)pe(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)pe(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function kt(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function ht(t,e=S){throw kt(t)}const Ot=Symbol("fallback");function Ze(t){for(let e=0;e<t.length;e++)t[e]()}function Tt(t,e,o={}){let n=[],s=[],i=[],r=0,c=e.length>1?[]:null;return Ue(()=>Ze(i)),()=>{let a=t()||[],d=a.length,u,l;return a[Ke],V(()=>{let v,w,A,T,Ce,F,R,H,ee;if(d===0)r!==0&&(Ze(i),i=[],n=[],s=[],r=0,c&&(c=[])),o.fallback&&(n=[Ot],s[0]=De(It=>(i[0]=It,o.fallback())),r=1);else if(r===0){for(s=new Array(d),l=0;l<d;l++)n[l]=a[l],s[l]=De(g);r=d}else{for(A=new Array(d),T=new Array(d),c&&(Ce=new Array(d)),F=0,R=Math.min(r,d);F<R&&n[F]===a[F];F++);for(R=r-1,H=d-1;R>=F&&H>=F&&n[R]===a[H];R--,H--)A[H]=s[R],T[H]=i[R],c&&(Ce[H]=c[R]);for(v=new Map,w=new Array(H+1),l=H;l>=F;l--)ee=a[l],u=v.get(ee),w[l]=u===void 0?-1:u,v.set(ee,l);for(u=F;u<=R;u++)ee=n[u],l=v.get(ee),l!==void 0&&l!==-1?(A[l]=s[u],T[l]=i[u],c&&(Ce[l]=c[u]),l=w[l],v.set(ee,l)):i[u]();for(l=F;l<d;l++)l in A?(s[l]=A[l],i[l]=T[l],c&&(c[l]=Ce[l],c[l](l))):s[l]=De(g);s=s.slice(0,r=d),n=a.slice(0)}return s});function g(v){if(i[l]=v,c){const[w,A]=de(l);return c[l]=A,e(a[l],w)}return e(a[l])}}}function I(t,e){return V(()=>t(e||{}))}const Lt=t=>`Stale read from <${t}>.`;function oe(t){const e="fallback"in t&&{fallback:()=>t.fallback};return L(Tt(()=>t.each,t.children,e||void 0))}function ge(t){const e=t.keyed,o=L(()=>t.when,void 0,{equals:(n,s)=>e?n===s:!n==!s});return L(()=>{const n=o();if(n){const s=t.children;return typeof s=="function"&&s.length>0?V(()=>s(e?n:()=>{if(!V(o))throw Lt("Show");return t.when})):s}return t.fallback},void 0,void 0)}function _t(t,e,o){let n=o.length,s=e.length,i=n,r=0,c=0,a=e[s-1].nextSibling,d=null;for(;r<s||c<i;){if(e[r]===o[c]){r++,c++;continue}for(;e[s-1]===o[i-1];)s--,i--;if(s===r){const u=i<n?c?o[c-1].nextSibling:o[i-c]:a;for(;c<i;)t.insertBefore(o[c++],u)}else if(i===c)for(;r<s;)(!d||!d.has(e[r]))&&e[r].remove(),r++;else if(e[r]===o[i-1]&&o[c]===e[s-1]){const u=e[--s].nextSibling;t.insertBefore(o[c++],e[r++].nextSibling),t.insertBefore(o[--i],u),e[s]=o[i]}else{if(!d){d=new Map;let l=c;for(;l<i;)d.set(o[l],l++)}const u=d.get(e[r]);if(u!=null)if(c<u&&u<i){let l=r,g=1,v;for(;++l<s&&l<i&&!((v=d.get(e[l]))==null||v!==u+g);)g++;if(g>u-c){const w=e[r];for(;c<u;)t.insertBefore(o[c++],w)}else t.replaceChild(o[c++],e[r++])}else r++;else e[r++].remove()}}}const Xe="_$DX_DELEGATE";function $t(t,e,o,n={}){let s;return De(i=>{s=i,e===document?t():O(e,t(),e.firstChild?null:void 0,o)},n.owner),()=>{s(),e.textContent=""}}function $(t,e,o){let n;const s=()=>{const r=document.createElement("template");return r.innerHTML=t,o?r.content.firstChild.firstChild:r.content.firstChild},i=e?()=>V(()=>document.importNode(n||(n=s()),!0)):()=>(n||(n=s())).cloneNode(!0);return i.cloneNode=i,i}function we(t,e=window.document){const o=e[Xe]||(e[Xe]=new Set);for(let n=0,s=t.length;n<s;n++){const i=t[n];o.has(i)||(o.add(i),e.addEventListener(i,Kt))}}function b(t,e,o){o==null?t.removeAttribute(e):t.setAttribute(e,o)}function xe(t,e){e==null?t.removeAttribute("class"):t.className=e}function Be(t,e,o={}){const n=Object.keys(e||{}),s=Object.keys(o);let i,r;for(i=0,r=s.length;i<r;i++){const c=s[i];!c||c==="undefined"||e[c]||(qe(t,c,!1),delete o[c])}for(i=0,r=n.length;i<r;i++){const c=n[i],a=!!e[c];!c||c==="undefined"||o[c]===a||!a||(qe(t,c,!0),o[c]=a)}return o}function Ge(t,e,o){return V(()=>t(e,o))}function O(t,e,o,n){if(o!==void 0&&!n&&(n=[]),typeof e!="function")return Ae(t,e,n,o);x(s=>Ae(t,e(),s,o),n)}function qe(t,e,o){const n=e.trim().split(/\s+/);for(let s=0,i=n.length;s<i;s++)t.classList.toggle(n[s],o)}function Kt(t){let e=t.target;const o=`$$${t.type}`,n=t.target,s=t.currentTarget,i=a=>Object.defineProperty(t,"target",{configurable:!0,value:a}),r=()=>{const a=e[o];if(a&&!e.disabled){const d=e[`${o}Data`];if(d!==void 0?a.call(e,d,t):a.call(e,t),t.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(t.target)&&i(e.host),!0},c=()=>{for(;r()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(t,"currentTarget",{configurable:!0,get(){return e||document}}),t.composedPath){const a=t.composedPath();i(a[0]);for(let d=0;d<a.length-2&&(e=a[d],!!r());d++){if(e._$host){e=e._$host,c();break}if(e.parentNode===s)break}}else c();i(n)}function Ae(t,e,o,n,s){for(;typeof o=="function";)o=o();if(e===o)return o;const i=typeof e,r=n!==void 0;if(t=r&&o[0]&&o[0].parentNode||t,i==="string"||i==="number"){if(i==="number"&&(e=e.toString(),e===o))return o;if(r){let c=o[0];c&&c.nodeType===3?c.data!==e&&(c.data=e):c=document.createTextNode(e),o=te(t,o,n,c)}else o!==""&&typeof o=="string"?o=t.firstChild.data=e:o=t.textContent=e}else if(e==null||i==="boolean")o=te(t,o,n);else{if(i==="function")return x(()=>{let c=e();for(;typeof c=="function";)c=c();o=Ae(t,c,o,n)}),()=>o;if(Array.isArray(e)){const c=[],a=o&&Array.isArray(o);if(Fe(c,e,o,s))return x(()=>o=Ae(t,c,o,n,!0)),()=>o;if(c.length===0){if(o=te(t,o,n),r)return o}else a?o.length===0?Qe(t,c,n):_t(t,o,c):(o&&te(t),Qe(t,c));o=c}else if(e.nodeType){if(Array.isArray(o)){if(r)return o=te(t,o,n,e);te(t,o,null,e)}else o==null||o===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);o=e}}return o}function Fe(t,e,o,n){let s=!1;for(let i=0,r=e.length;i<r;i++){let c=e[i],a=o&&o[t.length],d;if(!(c==null||c===!0||c===!1))if((d=typeof c)=="object"&&c.nodeType)t.push(c);else if(Array.isArray(c))s=Fe(t,c,a)||s;else if(d==="function")if(n){for(;typeof c=="function";)c=c();s=Fe(t,Array.isArray(c)?c:[c],Array.isArray(a)?a:[a])||s}else t.push(c),s=!0;else{const u=String(c);a&&a.nodeType===3&&a.data===u?t.push(a):t.push(document.createTextNode(u))}}return s}function Qe(t,e,o=null){for(let n=0,s=e.length;n<s;n++)t.insertBefore(e[n],o)}function te(t,e,o,n){if(o===void 0)return t.textContent="";const s=n||document.createTextNode("");if(e.length){let i=!1;for(let r=e.length-1;r>=0;r--){const c=e[r];if(s!==c){const a=c.parentNode===t;!i&&!r?a?t.replaceChild(s,c):t.insertBefore(s,o):a&&c.remove()}else i=!0}}else t.insertBefore(s,o);return[s]}const ze=Symbol("store-raw"),ie=Symbol("store-node"),W=Symbol("store-has"),ft=Symbol("store-self");function pt(t){let e=t[J];if(!e&&(Object.defineProperty(t,J,{value:e=new Proxy(t,Rt)}),!Array.isArray(t))){const o=Object.keys(t),n=Object.getOwnPropertyDescriptors(t);for(let s=0,i=o.length;s<i;s++){const r=o[s];n[r].get&&Object.defineProperty(t,r,{enumerable:n[r].enumerable,get:n[r].get.bind(e)})}}return e}function re(t){let e;return t!=null&&typeof t=="object"&&(t[J]||!(e=Object.getPrototypeOf(t))||e===Object.prototype||Array.isArray(t))}function ce(t,e=new Set){let o,n,s,i;if(o=t!=null&&t[ze])return o;if(!re(t)||e.has(t))return t;if(Array.isArray(t)){Object.isFrozen(t)?t=t.slice(0):e.add(t);for(let r=0,c=t.length;r<c;r++)s=t[r],(n=ce(s,e))!==s&&(t[r]=n)}else{Object.isFrozen(t)?t=Object.assign({},t):e.add(t);const r=Object.keys(t),c=Object.getOwnPropertyDescriptors(t);for(let a=0,d=r.length;a<d;a++)i=r[a],!c[i].get&&(s=t[i],(n=ce(s,e))!==s&&(t[i]=n))}return t}function ke(t,e){let o=t[e];return o||Object.defineProperty(t,e,{value:o=Object.create(null)}),o}function ve(t,e,o){if(t[e])return t[e];const[n,s]=de(o,{equals:!1,internal:!0});return n.$=s,t[e]=n}function Bt(t,e){const o=Reflect.getOwnPropertyDescriptor(t,e);return!o||o.get||!o.configurable||e===J||e===ie||(delete o.value,delete o.writable,o.get=()=>t[J][e]),o}function gt(t){Pe()&&ve(ke(t,ie),ft)()}function Ft(t){return gt(t),Reflect.ownKeys(t)}const Rt={get(t,e,o){if(e===ze)return t;if(e===J)return o;if(e===Ke)return gt(t),o;const n=ke(t,ie),s=n[e];let i=s?s():t[e];if(e===ie||e===W||e==="__proto__")return i;if(!s){const r=Object.getOwnPropertyDescriptor(t,e);Pe()&&(typeof i!="function"||t.hasOwnProperty(e))&&!(r&&r.get)&&(i=ve(n,e,i)())}return re(i)?pt(i):i},has(t,e){return e===ze||e===J||e===Ke||e===ie||e===W||e==="__proto__"?!0:(Pe()&&ve(ke(t,W),e)(),e in t)},set(){return!0},deleteProperty(){return!0},ownKeys:Ft,getOwnPropertyDescriptor:Bt};function ae(t,e,o,n=!1){if(!n&&t[e]===o)return;const s=t[e],i=t.length;o===void 0?(delete t[e],t[W]&&t[W][e]&&s!==void 0&&t[W][e].$()):(t[e]=o,t[W]&&t[W][e]&&s===void 0&&t[W][e].$());let r=ke(t,ie),c;if((c=ve(r,e,s))&&c.$(()=>o),Array.isArray(t)&&t.length!==i){for(let a=t.length;a<i;a++)(c=r[a])&&c.$();(c=ve(r,"length",i))&&c.$(t.length)}(c=r[ft])&&c.$()}function vt(t,e){const o=Object.keys(e);for(let n=0;n<o.length;n+=1){const s=o[n];ae(t,s,e[s])}}function Ht(t,e){if(typeof e=="function"&&(e=e(t)),e=ce(e),Array.isArray(e)){if(t===e)return;let o=0,n=e.length;for(;o<n;o++){const s=e[o];t[o]!==s&&ae(t,o,s)}ae(t,"length",n)}else vt(t,e)}function ue(t,e,o=[]){let n,s=t;if(e.length>1){n=e.shift();const r=typeof n,c=Array.isArray(t);if(Array.isArray(n)){for(let a=0;a<n.length;a++)ue(t,[n[a]].concat(e),o);return}else if(c&&r==="function"){for(let a=0;a<t.length;a++)n(t[a],a)&&ue(t,[a].concat(e),o);return}else if(c&&r==="object"){const{from:a=0,to:d=t.length-1,by:u=1}=n;for(let l=a;l<=d;l+=u)ue(t,[l].concat(e),o);return}else if(e.length>1){ue(t[n],e,[n].concat(o));return}s=t[n],o=[n].concat(o)}let i=e[0];typeof i=="function"&&(i=i(s,o),i===s)||n===void 0&&i==null||(i=ce(i),n===void 0||re(s)&&re(i)&&!Array.isArray(i)?vt(s,i):ae(t,n,i))}function _(...[t,e]){const o=ce(t||{}),n=Array.isArray(o),s=pt(o);function i(...r){Ne(()=>{n&&r.length===1?Ht(o,r[0]):ue(o,r)})}return[s,i]}const Oe=new WeakMap,yt={get(t,e){if(e===ze)return t;const o=t[e];let n;return re(o)?Oe.get(o)||(Oe.set(o,n=new Proxy(o,yt)),n):o},set(t,e,o){return ae(t,e,ce(o)),!0},deleteProperty(t,e){return ae(t,e,void 0,!0),!0}};function Re(t){return e=>{if(re(e)){let o;(o=Oe.get(e))||Oe.set(e,o=new Proxy(e,yt)),t(o)}return e}}(function(){try{if(typeof document<"u"){var t=document.createElement("style");t.appendChild(document.createTextNode("@layer nodeflow{.nodeflowConnectorSection{position:absolute;display:flex;justify-content:space-evenly;width:0;height:0;top:50%;left:50%}.nodeflowNode{position:absolute;border:1px solid black;-webkit-user-select:none;user-select:none;z-index:1;cursor:grab}.nodeflowSelectionBox{position:absolute;background-color:#0000001a;border:2px solid rgba(0,0,0,.3);border-radius:4px;pointer-events:none;z-index:10}}")),document.head.appendChild(t)}}catch(e){console.error("vite-plugin-css-injected-by-js",e)}})();var Ut=Object.defineProperty,Wt=(t,e,o)=>e in t?Ut(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,f=(t,e,o)=>(Wt(t,typeof e!="symbol"?e+"":e,o),o),mt=(t,e,o)=>{if(!e.has(t))throw TypeError("Cannot "+o)},m=(t,e,o)=>(mt(t,e,"read from private field"),o?o.call(t):e.get(t)),He=(t,e,o)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,o)},Gt=(t,e,o,n)=>(mt(t,e,"write to private field"),e.set(t,o),o);class h{constructor(e,o){f(this,"x"),f(this,"y"),this.x=e,this.y=o}static zero(){return new h(0,0)}static of(e,o){return new h(e,o)}static fromEvent(e){return new h(e.clientX,e.clientY)}static fromVec2(e){return new h(e.x,e.y)}copy(){return h.fromVec2(this)}serialize(){return{x:this.x,y:this.y}}static deserialize(e){return new h(e.x,e.y)}static deserializeOrDefault(e,o=h.zero()){return e?h.deserialize(e):o}add(...e){return e.reduce((o,n)=>new h(o.x+n.x,o.y+n.y),this)}subtract(...e){return e.reduce((o,n)=>new h(o.x-n.x,o.y-n.y),this)}multiply(...e){return e.reduce((o,n)=>new h(o.x*n.x,o.y*n.y),this)}divide(...e){return e.reduce((o,n)=>new h(n.x/o.x,n.y/o.y),this)}negate(){return new h(-this.x,-this.y)}shift(e){return new h(this.x+e,this.y+e)}multiplyBy(e){return new h(this.x*e,this.y*e)}divideBy(e){return new h(this.x/e,this.y/e)}isWithinRect(e,o){return this.x>=e.x&&this.x<=e.x+o.x&&this.y>=e.y&&this.y<=e.y+o.y}distanceTo(e){return Math.hypot(this.x-e.x,this.y-e.y)}abs(){return h.of(Math.abs(this.x),Math.abs(this.y))}equals(e){return this.x===e.x&&this.y===e.y}hashCode(){return`${this.x}:${this.y}`}get magnitude(){return Math.hypot(this.x,this.y)}normalize(){const e=this.magnitude;return e===0?h.zero():new h(this.x/e,this.y/e)}}var Yt=$("<div>");const jt=t=>(()=>{var e=Yt();return e.$$pointerup=o=>t.nodeflowData.eventStore.onPointerUpInConnector.publish({event:o,nodeId:t.nodeId,connectorId:t.connectorId}),e.$$touchstart=o=>t.nodeflowData.eventStore.onTouchStartInConnector.publish({event:o,nodeId:t.nodeId,connectorId:t.connectorId}),e.$$mousedown=o=>t.nodeflowData.eventStore.onMouseDownInConnector.publish({event:o,nodeId:t.nodeId,connectorId:t.connectorId}),Ge(o=>setTimeout(()=>{var n,s;if(!o||!t.nodeflowData.nodes.has(t.nodeId))return;const i=t.nodeflowData.nodes.get(t.nodeId).connectorSections.get(t.sectionId).connectors.get(t.connectorId),r=new ResizeObserver(()=>{i.size=h.of(o.offsetWidth,o.offsetHeight)});r.observe(o),i.update({position:h.of((((n=o?.parentElement)==null?void 0:n.offsetLeft)??0)+o.offsetLeft,(((s=o?.parentElement)==null?void 0:s.offsetTop)??0)+o.offsetTop),ref:o,resizeObserver:r,size:h.of(o.offsetWidth,o.offsetHeight)})}),e),x(o=>{var n,s=(n=t.connector)==null?void 0:n.css,i=`connector-${t.connectorId}`;return s!==o.e&&xe(e,o.e=s),i!==o.t&&b(e,"id",o.t=i),o},{e:void 0,t:void 0}),e})();we(["mousedown","touchstart","pointerup"]);var Je=$("<svg><circle r=4 fill=none></svg>",!1,!0),Vt=$("<svg><path stroke=black stroke-width=1 fill=transparent>");const Zt=t=>{const e=L(()=>{const{mouseData:o,curveFunctions:n}=t.nodeflowData;if(o.heldConnectors.length!==1)return;const s=o.heldConnectors[0],i=s.parentNode,r=s.getCenter(),c=o.globalMousePosition(),{anchorStart:a,anchorEnd:d}=n.calculateCurveAnchors(r,c,i.getCenter(),c);return{start:r,end:c,anchorStart:a,anchorEnd:d,path:n.createDefaultCurvePath(r,c,a,d)}});return(()=>{var o=Vt(),n=o.firstChild;return o.style.setProperty("z-index","2"),o.style.setProperty("position","absolute"),o.style.setProperty("width","1px"),o.style.setProperty("height","1px"),o.style.setProperty("pointer-events","none"),o.style.setProperty("overflow","visible"),O(o,I(ge,{get when(){return t.nodeflowData.settings.debugMode},get children(){return[(()=>{var s=Je();return x(i=>{var r,c,a=(r=e())==null?void 0:r.anchorStart.x,d=(c=e())==null?void 0:c.anchorStart.y,u=t.css??"";return a!==i.e&&b(s,"cx",i.e=a),d!==i.t&&b(s,"cy",i.t=d),u!==i.a&&b(s,"class",i.a=u),i},{e:void 0,t:void 0,a:void 0}),s})(),(()=>{var s=Je();return x(i=>{var r,c,a=(r=e())==null?void 0:r.anchorEnd.x,d=(c=e())==null?void 0:c.anchorEnd.y,u=t.css??"";return a!==i.e&&b(s,"cx",i.e=a),d!==i.t&&b(s,"cy",i.t=d),u!==i.a&&b(s,"class",i.a=u),i},{e:void 0,t:void 0,a:void 0}),s})()]}}),null),x(s=>{var i,r=(i=e())==null?void 0:i.path,c=t.css;return r!==s.e&&b(n,"d",s.e=r),c!==s.t&&b(n,"class",s.t=c),s},{e:void 0,t:void 0}),o})()};var Xt=$("<svg><path stroke=black stroke-width=1 fill=none></svg>",!1,!0),et=$("<svg><circle r=4 fill=none></svg>",!1,!0);const qt=t=>{const e=L(()=>t.nodeflowData.nodes.get(t.sourceNodeId)),o=L(()=>t.nodeflowData.nodes.get(t.destinationNodeId)),n=L(()=>e().getConnector(t.sourceConnectorId)),s=L(()=>o().getConnector(t.destinationConnectorId)),i=L(()=>{var r,c;return!e()||!o()?-1:((c=(r=n())==null?void 0:r.destinations)==null?void 0:c.findIndex(a=>a.destinationConnector===s()))??-1});return fe(()=>{if(i()<0)return;const{curveFunctions:r}=t.nodeflowData,c=e().getConnector(t.sourceConnectorId),a=o().getConnector(t.destinationConnectorId),d=c.getCenter(),u=a.getCenter(),{anchorStart:l,anchorEnd:g}=r.calculateCurveAnchors(d,u,e().getCenter(),o().getCenter());n().destinations.get(i()).path={start:d,end:u,anchorStart:l,anchorEnd:g,path:r.createDefaultCurvePath(d,u,l,g)}}),[(()=>{var r=Xt();return r.$$pointerdown=c=>{t.nodeflowData.eventStore.onPointerDownInNodeCurve.publish({event:c,sourceConnector:n(),destinationConnector:s()})},r.style.setProperty("cursor","pointer"),r.style.setProperty("pointer-events","visibleStroke"),x(c=>{var a,d,u,l=(a=n().destinations.get(i()).path)==null?void 0:a.path,g={[((d=t.css)==null?void 0:d.normal)??""]:!0,[((u=t.css)==null?void 0:u.selected)??""]:t.nodeflowData.mouseData.hasSelectedConnection(t.sourceNodeId,t.sourceConnectorId,t.destinationNodeId,t.destinationConnectorId)};return l!==c.e&&b(r,"d",c.e=l),c.t=Be(r,g,c.t),c},{e:void 0,t:void 0}),r})(),I(ge,{get when(){return t.nodeflowData.settings.debugMode},get children(){return[(()=>{var r=et();return x(c=>{var a,d,u,l,g,v=(d=(a=n().destinations.get(i()).path)==null?void 0:a.anchorStart)==null?void 0:d.x,w=(l=(u=n().destinations.get(i()).path)==null?void 0:u.anchorStart)==null?void 0:l.y,A=((g=t.css)==null?void 0:g.normal)??"";return v!==c.e&&b(r,"cx",c.e=v),w!==c.t&&b(r,"cy",c.t=w),A!==c.a&&b(r,"class",c.a=A),c},{e:void 0,t:void 0,a:void 0}),r})(),(()=>{var r=et();return x(c=>{var a,d,u,l,g,v=(d=(a=n().destinations.get(i()).path)==null?void 0:a.anchorEnd)==null?void 0:d.x,w=(l=(u=n().destinations.get(i()).path)==null?void 0:u.anchorEnd)==null?void 0:l.y,A=((g=t.css)==null?void 0:g.normal)??"";return v!==c.e&&b(r,"cx",c.e=v),w!==c.t&&b(r,"cy",c.t=w),A!==c.a&&b(r,"class",c.a=A),c},{e:void 0,t:void 0,a:void 0}),r})()]}})]};we(["pointerdown"]);var Qt=$("<div class=nodeflowNode>"),Jt=$("<div>");const eo=t=>{const e=L(()=>t.nodeflowData.nodes.get(t.nodeId)),[o,n]=de(!1);return Ue(()=>{t.nodeflowData.chunking.removeNodeFromChunk(t.nodeId,e().position),e().resizeObserver&&(e().resizeObserver.disconnect(),Array.from(e().connectorSections.values()).forEach(s=>{Array.from(s.connectors.values()).forEach(i=>{i.resizeObserver&&i.resizeObserver.disconnect()})}))}),(()=>{var s=Qt();return s.$$pointerup=i=>t.nodeflowData.eventStore.onPointerUpInNode.publish({event:i,nodeId:t.nodeId}),s.$$touchstart=i=>t.nodeflowData.eventStore.onTouchStartInNode.publish({event:i,nodeId:t.nodeId}),s.$$mousedown=i=>t.nodeflowData.eventStore.onMouseDownInNode.publish({event:i,nodeId:t.nodeId}),Ge(i=>setTimeout(()=>{if(!i)return;const r=new ResizeObserver(()=>{e().update({size:h.of(i.clientWidth,i.clientHeight)}),Array.from(e().connectorSections.values()).forEach(a=>Array.from(a.connectors.values()).forEach(d=>{var u,l;const g=d.ref;g&&(d.position=h.of((((u=g?.parentElement)==null?void 0:u.offsetLeft)??0)+g.offsetLeft,(((l=g?.parentElement)==null?void 0:l.offsetTop)??0)+g.offsetTop))}))});r.observe(i);const c=e().centered?h.of(i.clientWidth,i.clientHeight).divideBy(2):h.zero();e().update({offset:h.of(i.clientLeft,i.clientTop),ref:i,resizeObserver:r,position:e().position.subtract(c),size:h.of(i.clientWidth,i.clientHeight)}),n(!0)}),s),O(s,()=>e().display({node:e()}),null),O(s,I(oe,{get each(){return Array.from(e().connectorSections.entries())},children:([i,r])=>(()=>{var c=Jt();return b(c,"id",`section-${i}`),O(c,I(oe,{get each(){return Array.from(r.connectors.entries())},children:([a,d])=>I(jt,{connector:d,connectorId:a,get nodeId(){return t.nodeId},sectionId:i,get nodeflowData(){return t.nodeflowData}})})),x(a=>Be(c,{[r?.css??""]:!0,nodeflowConnectorSection:!0},a)),c})()}),null),x(i=>{var r,c,a,d,u=`${e().position.x}px`,l=`${e().position.y}px`,g=o()?1:0,v=`node-${t.nodeId}`,w={[((c=(r=e())==null?void 0:r.css)==null?void 0:c.normal)??""]:!0,[((d=(a=e())==null?void 0:a.css)==null?void 0:d.selected)??""]:t.nodeflowData.mouseData.hasSelectedNode(t.nodeId)||t.nodeflowData.mouseData.selectionBox.selections.isNodeSelected(t.nodeId)};return u!==i.e&&((i.e=u)!=null?s.style.setProperty("left",u):s.style.removeProperty("left")),l!==i.t&&((i.t=l)!=null?s.style.setProperty("top",l):s.style.removeProperty("top")),g!==i.a&&((i.a=g)!=null?s.style.setProperty("opacity",g):s.style.removeProperty("opacity")),v!==i.o&&b(s,"id",i.o=v),i.i=Be(s,w,i.i),i},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),s})()};we(["mousedown","touchstart","pointerup"]);var to=$("<div class=nodeflowSelectionBox>");const oo=t=>{const e=L(()=>t.nodeflowData.mouseData.selectionBox.boundingBox.startPosition()),o=L(()=>t.nodeflowData.mouseData.selectionBox.boundingBox.size.abs());return(()=>{var n=to();return x(s=>{var i=`${e().x}px`,r=`${e().y}px`,c=`${o().x}px`,a=`${o().y}px`;return i!==s.e&&((s.e=i)!=null?n.style.setProperty("left",i):n.style.removeProperty("left")),r!==s.t&&((s.t=r)!=null?n.style.setProperty("top",r):n.style.removeProperty("top")),c!==s.a&&((s.a=c)!=null?n.style.setProperty("width",c):n.style.removeProperty("width")),a!==s.o&&((s.o=a)!=null?n.style.setProperty("height",a):n.style.removeProperty("height")),s},{e:void 0,t:void 0,a:void 0,o:void 0}),n})()};var no=$("<div tabindex=0><div><svg>");const so=t=>e=>(()=>{var o=no(),n=o.firstChild,s=n.firstChild;return o.$$touchmove=i=>t.eventStore.onTouchMoveInNodeflow.publish({event:i}),o.$$touchstart=i=>t.eventStore.onTouchStartInNodeflow.publish({event:i}),o.$$keyup=i=>t.eventStore.onKeyUpInNodeflow.publish({event:i}),o.$$keydown=i=>t.eventStore.onKeyDownInNodeflow.publish({event:i}),o.$$mousedown=i=>t.eventStore.onMouseDownInNodeflow.publish({event:i}),o.addEventListener("wheel",i=>t.eventStore.onWheelInNodeflow.publish({event:i})),o.$$pointerup=i=>t.eventStore.onPointerUpInNodeflow.publish({event:i}),o.$$mousemove=i=>t.eventStore.onMouseMoveInNodeflow.publish({event:i}),Ge(i=>{new ResizeObserver(()=>{t.update({size:h.of(i.clientWidth,i.clientHeight),startPosition:h.of(i.offsetLeft,i.offsetTop)})}).observe(i)},o),o.style.setProperty("overflow","hidden"),n.style.setProperty("position","absolute"),n.style.setProperty("transform-origin","center"),n.style.setProperty("transition","scale 0.1s ease-out"),O(n,I(oe,{get each(){return Array.from(t.nodes.keys())},children:i=>I(eo,{nodeId:i,nodeflowData:t})}),s),s.style.setProperty("z-index","2"),s.style.setProperty("position","absolute"),s.style.setProperty("width","1px"),s.style.setProperty("height","1px"),s.style.setProperty("pointer-events","none"),s.style.setProperty("overflow","visible"),O(s,I(oe,{get each(){return Array.from(t.nodes.entries())},children:([i,r])=>I(oe,{get each(){return r.getAllConnectors()},children:c=>I(oe,{get each(){return c.destinations.array},children:a=>I(qt,{nodeflowData:t,sourceNodeId:i,get sourceConnectorId(){return c.id},get destinationNodeId(){return a.destinationConnector.parentSection.parentNode.id},get destinationConnectorId(){return a.destinationConnector.id},get css(){return a.css}})})})})),O(n,I(ge,{get when(){return t.mouseData.heldConnectors.length===1},get children(){return I(Zt,{get css(){var i,r;return(r=(i=e?.css)==null?void 0:i.getNewCurveCss)==null?void 0:r.call(i,t.mouseData.heldConnectors.at(0))},nodeflowData:t})}}),null),O(o,I(ge,{get when(){return t.mouseData.selectionBox.boundingBox},get children(){return I(oo,{nodeflowData:t})}}),null),x(i=>{var r,c=`nodeflow-${t.id}`,a=(r=e?.css)==null?void 0:r.nodeflow,d=e.height,u=e.width,l=`scale(${t.zoomLevel}) translate(${t.position.x}px, ${t.position.y}px)`;return c!==i.e&&b(o,"id",i.e=c),a!==i.t&&xe(o,i.t=a),d!==i.a&&((i.a=d)!=null?o.style.setProperty("height",d):o.style.removeProperty("height")),u!==i.o&&((i.o=u)!=null?o.style.setProperty("width",u):o.style.removeProperty("width")),l!==i.i&&((i.i=l)!=null?n.style.setProperty("transform",l):n.style.removeProperty("transform")),i},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),o})();we(["mousemove","pointerup","mousedown","keydown","keyup","touchstart","touchmove"]);class ne{constructor(e){f(this,"store"),this.store=_(e??[])}get array(){return this.store[0]}get length(){return this.store[0].length}at(e){return this.store[0].at(e)}forEach(e){this.store[0].forEach(e)}filter(e){return this.store[0].filter(e)}filterInPlace(e){this.store[1](this.filter(e))}map(e){return this.store[0].map(e)}flatMap(e){return this.store[0].flatMap(e)}find(e){return this.store[0].find(e)}findIndex(e){return this.store[0].findIndex(e)}splice(e,o,...n){this.store[1](this.store[0].splice(e,o,...n))}reduce(e,o){return this.store[0].reduce(e,o)}some(e){return this.store[0].some(e)}every(e){return this.store[0].every(e)}get(e){return this.store[0][e]}set(e,o){this.store[1](e,o)}push(e){this.store[1](this.store[0].length,e)}}class k{constructor(e=-1){f(this,"changes"),f(this,"currentChangeIndex",-1),f(this,"maxChanges"),this.maxChanges=e,this.changes=[]}serialize(){return{changes:this.changes,currentChangeIndex:this.currentChangeIndex,maxChanges:this.maxChanges}}deserialize(e){this.changes=e.changes,this.currentChangeIndex=e.currentChangeIndex,this.maxChanges=e.maxChanges}addChange(e){this.changes=this.changes.slice(0,this.currentChangeIndex+1),this.changes.length===this.maxChanges&&this.changes.shift(),this.changes.push(e),this.currentChangeIndex=this.changes.length-1}undo(){if(this.currentChangeIndex===-1)return!1;const e=this.changes[this.currentChangeIndex].historyGroup;for(;this.currentChangeIndex>-1&&this.changes[this.currentChangeIndex].historyGroup===e;)this.changes[this.currentChangeIndex].undoChange(),this.currentChangeIndex--;return!0}redo(){if(this.currentChangeIndex===this.changes.length-1)return!1;const e=this.changes[this.currentChangeIndex+1].historyGroup;for(;this.currentChangeIndex<this.changes.length-1&&this.changes[this.currentChangeIndex+1].historyGroup===e;)this.currentChangeIndex++,this.changes[this.currentChangeIndex].applyChange();return!0}static evaluateHistoryGroup(e=!0){return typeof e=="boolean"?e?crypto.randomUUID():!1:e}}class wt{constructor(e){f(this,"nodeflowData"),f(this,"getHorizontalCurve",(o,n)=>h.of((n.x-o.x)/1.5,0)),f(this,"getVerticalCurve",(o,n)=>h.of(0,(n.y-o.y)/1.5)),f(this,"createDefaultCurvePath",(o,n,s,i)=>`M ${o.x} ${o.y} C ${s.x} ${s.y}, ${i.x} ${i.y}, ${n.x} ${n.y}`),this.nodeflowData=e}calculateCurveAnchors(e,o,n,s){const i=e.distanceTo(o)/300,r=n.add(e.subtract(n).multiplyBy(i)),c=s.add(o.subtract(s).multiplyBy(i));return{anchorStart:r,anchorEnd:c}}}class io{constructor(e){f(this,"store"),this.store=_(e)}get css(){return this.store[0].css}get destinationConnector(){return this.store[0].destinationConnector}get path(){return this.store[0].path}set css(e){this.store[1]({css:e})}set path(e){this.store[1]({path:e})}set destinationConnector(e){this.store[1]({destinationConnector:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}}const he=(...t)=>{const e=t[0];return t.slice(1).reduce((o,n)=>new Set([...o].filter(s=>n.has(s))),e)},se=t=>t.size===0,G=t=>typeof t!="object"||t===null||t===void 0?t:Array.isArray(t)?t.map(G):typeof t=="object"?Object.fromEntries(Object.entries(t).map(([e,o])=>[e,G(o)])):t;class Ye{constructor(e){f(this,"store"),this.store=_(e)}serialize(){return{css:this.css,hovered:this.hovered,id:this.id,position:this.position.serialize()}}serializeConnections(){return[...this.destinations.map(({destinationConnector:e,css:o})=>({sourceNodeId:this.parentNode.id,sourceConnectorId:this.id,destinationNodeId:e.parentNode.id,destinationConnectorId:e.id,css:G(o)})),...this.sources.map(({sourceConnector:e})=>{var o;return{sourceNodeId:e.parentNode.id,sourceConnectorId:e.id,destinationNodeId:this.parentNode.id,destinationConnectorId:this.id,css:G((o=e.destinations.find(n=>n.destinationConnector.parentNode.id===this.parentNode.id))==null?void 0:o.css)}})]}static deserialize(e,o){const n=!e.id||o.connectors.has(e.id)?o.parentNode.getNextFreeConnectorId():e.id;return new Ye({css:e.css,destinations:new ne,hovered:e.hovered??!1,id:n,parentSection:o,position:h.deserializeOrDefault(e.position),ref:void 0,resizeObserver:void 0,size:h.zero(),sources:new ne})}get css(){return this.store[0].css}values(){return this.store[0]}get destinations(){return this.store[0].destinations}get hovered(){return this.store[0].hovered}get id(){return this.store[0].id}get parentSection(){return this.store[0].parentSection}get parentNode(){return this.store[0].parentSection.parentNode}get position(){return this.store[0].position}get ref(){return this.store[0].ref}get resizeObserver(){return this.store[0].resizeObserver}get size(){return this.store[0].size}get sources(){return this.store[0].sources}set css(e){this.store[1]({css:e})}set destinations(e){this.store[1]({destinations:e})}set hovered(e){this.store[1]({hovered:e})}set id(e){this.store[1]({id:e})}set parentSection(e){this.store[1]({parentSection:e})}set position(e){this.store[1]({position:e})}set ref(e){this.store[1]({ref:e})}set resizeObserver(e){this.store[1]({resizeObserver:e})}set size(e){this.store[1]({size:e})}set sources(e){this.store[1]({sources:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}removeIncomingConnections(){this.sources.forEach(({sourceConnector:e})=>{e.destinations.filterInPlace(({destinationConnector:o})=>o.parentNode.id!==this.id)}),this.sources=new ne}removeOutgoingConnections(){this.destinations.forEach(({destinationConnector:e})=>{e.sources.filterInPlace(({sourceConnector:o})=>o.parentNode.id!==this.id)}),this.destinations=new ne}getCenter(){const{position:e,offset:o}=this.parentNode;return e.add(o,this.position,this.size.divideBy(2))}}const Ct=class Se{constructor(){f(this,"nodeflows"),f(this,"globalEventStore"),this.nodeflows=new Map,this.globalEventStore={onMouseMoveInDocument:new _e,onPointerLeaveFromDocument:new _e,onPointerUpInDocument:new _e},this.setupDefaultEventHandlers()}static get(){return this.instance||(Se.instance=new Se),Se.instance}createCanvas(...e){const o=new fo(...e);return this.nodeflows.set(e[0],o),[o,so(o)]}getNodeflow(e){return this.nodeflows.get(e)}removeNodeflow(e){this.nodeflows.delete(e)}clear(){this.nodeflows.clear()}hasNodeflow(e){return this.nodeflows.has(e)}setupDefaultEventHandlers(){document.onmousemove=e=>this.globalEventStore.onMouseMoveInDocument.publish({event:e}),document.onpointerleave=e=>this.globalEventStore.onPointerLeaveFromDocument.publish({event:e}),document.onpointerup=e=>this.globalEventStore.onPointerUpInDocument.publish({event:e}),this.globalEventStore.onMouseMoveInDocument.subscribeMultiple([{name:"update-mouse-position",event:({event:e})=>{this.nodeflows.forEach(o=>{o.mouseData.mousePosition=h.fromEvent(e)})}}]),this.globalEventStore.onPointerLeaveFromDocument.subscribeMultiple([{name:"reset-mouse-data",event:()=>{this.nodeflows.forEach(e=>{e.mouseData.reset()})}}]),this.globalEventStore.onPointerUpInDocument.subscribeMultiple([])}};f(Ct,"instance");let N=Ct;var ro={equals:!1},co=ro,Z,tt,ot=(tt=class{constructor(t=Map){He(this,Z,void 0),Gt(this,Z,new t)}dirty(t){var e;(e=m(this,Z).get(t))==null||e.$$()}dirtyAll(){for(const t of m(this,Z).values())t.$$()}track(t){if(!Pe())return;let e=m(this,Z).get(t);if(e)e.n++;else{const[o,n]=de(void 0,co);m(this,Z).set(t,e={$:o,$$:n,n:1})}Ue(()=>{e.n--===1&&queueMicrotask(()=>e.n===0&&m(this,Z).delete(t))}),e.$()}},Z=new WeakMap,tt),X=Symbol("track-keys"),z,U,nt,j=(nt=class extends Map{constructor(t){if(super(),He(this,z,new ot),He(this,U,new ot),t)for(const e of t)super.set(e[0],e[1])}has(t){return m(this,z).track(t),super.has(t)}get(t){return m(this,U).track(t),super.get(t)}get size(){return m(this,z).track(X),super.size}*keys(){for(const t of super.keys())m(this,z).track(t),yield t;m(this,z).track(X)}*values(){for(const[t,e]of super.entries())m(this,U).track(t),yield e;m(this,z).track(X)}*entries(){for(const t of super.entries())m(this,U).track(t[0]),yield t;m(this,z).track(X)}set(t,e){return Ne(()=>{if(super.has(t)){if(super.get(t)===e)return}else m(this,z).dirty(t),m(this,z).dirty(X);m(this,U).dirty(t),super.set(t,e)}),this}delete(t){const e=super.delete(t);return e&&Ne(()=>{m(this,z).dirty(t),m(this,z).dirty(X),m(this,U).dirty(t)}),e}clear(){super.size&&Ne(()=>{for(const t of super.keys())m(this,z).dirty(t),m(this,U).dirty(t);super.clear(),m(this,z).dirty(X)})}forEach(t){m(this,z).track(X);for(const[e,o]of super.entries())m(this,U).track(e),t(o,e,this)}[Symbol.iterator](){return this.entries()}},z=new WeakMap,U=new WeakMap,nt);class je{constructor(e,o){f(this,"store"),f(this,"nodeflowData"),this.nodeflowData=e,this.store=_(o)}serialize(){return{connectors:Object.fromEntries(Array.from(this.connectors.entries()).map(([e,o])=>[e,o.serialize()])),css:this.css,id:this.id}}static deserialize(e,o,n=!0){const s=k.evaluateHistoryGroup(n),i=!e.id||o.connectorSections.has(e.id)?o.getNextFreeConnectorSectionId():e.id,r=new je(o.nodeflow,{connectors:new j,css:e.css,id:i,parentNode:o});for(const[c,a]of Object.entries(e.connectors??{}))r.addConnector({...a,id:c},s);return r}addConnector(e,o=!0){const n=Ye.deserialize(e,this);if(this.connectors.has(n.id))return this.connectors.get(n.id);const s=k.evaluateHistoryGroup(o);if(s){const i=n.serialize(),r=this.id,c=i.id,a=this.parentNode.id,d=this.nodeflowData.id;this.nodeflowData.changes.addChange({type:"add",source:"connector",applyChange:()=>{var u,l;(l=(u=N.get().getNodeflow(d))==null?void 0:u.nodes.get(a))==null||l.addConnector(r,i,!1)},undoChange:()=>{var u,l;(l=(u=N.get().getNodeflow(d))==null?void 0:u.nodes.get(a))==null||l.removeConnector(r,c,!1)},historyGroup:s})}return this.connectors.set(n.id,n),n}removeConnector(e,o=!0){if(!this.connectors.has(e))return;const n=this.connectors.get(e),s=k.evaluateHistoryGroup(o);if(s){const i=n.serialize(),r=this.id,c=i.id,a=this.parentNode.id,d=this.nodeflowData.id;this.nodeflowData.changes.addChange({type:"remove",source:"connector",applyChange:()=>{var u,l;(l=(u=N.get().getNodeflow(d))==null?void 0:u.nodes.get(a))==null||l.removeConnector(r,c,!1)},undoChange:()=>{var u,l;(l=(u=N.get().getNodeflow(d))==null?void 0:u.nodes.get(a))==null||l.addConnector(r,i,!1)},historyGroup:s})}this.connectors.delete(e)}get connectors(){return this.store[0].connectors}get css(){return this.store[0].css}get id(){return this.store[0].id}get parentNode(){return this.store[0].parentNode}set connectors(e){this.store[1]({connectors:e})}set css(e){this.store[1]({css:e})}set id(e){this.store[1]({id:e})}set parentNode(e){this.store[1]({parentNode:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}removeIncomingConnections(){this.connectors.forEach(e=>e.removeIncomingConnections())}removeOutgoingConnections(){this.connectors.forEach(e=>e.removeOutgoingConnections())}getSourceConnectors(){return Array.from(this.connectors.values()).flatMap(e=>e.sources.flatMap(o=>o.sourceConnector))}getDestinationConnectors(){return Array.from(this.connectors.values()).flatMap(e=>e.destinations.flatMap(o=>o.destinationConnector))}}class ao{constructor(e){f(this,"store"),this.store=_(e)}get sourceConnector(){return this.store[0].sourceConnector}set sourceConnector(e){this.store[1]({sourceConnector:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}}class Dt{constructor(){f(this,"subscriptions",new j),f(this,"blacklistFilters",new j)}blacklist(e,o){this.blacklistFilters.set(e,o)}unblacklist(e){this.blacklistFilters.delete(e)}unblacklistMultiple(e){e.forEach(this.unblacklist)}clearBlacklist(){this.blacklistFilters.clear()}subscribe(e,o,n=0){this.subscriptions.set(e,{name:e,event:o,priority:n})}subscribeMultiple(e){e.forEach(({name:o,event:n,priority:s})=>this.subscribe(o,n,s))}unsubscribe(e){this.subscriptions.delete(e)}unsubsribeMultiple(e){e.forEach(this.unsubscribe)}publish(e){Array.from(this.subscriptions.values()).sort((o,n)=>n.priority-o.priority).filter(({name:o,priority:n})=>!Array.from(this.blacklistFilters.values()).some(s=>s(e,o,n))).map(({event:o})=>o).forEach(o=>o(e))}clear(){this.subscriptions.clear()}get size(){return this.subscriptions.size}get isEmpty(){return this.size===0}}class P extends Dt{constructor(e){super(),f(this,"nodeflowData"),this.nodeflowData=e}}class _e extends Dt{}class lo{constructor(e){f(this,"store"),f(this,"nodeflowData"),this.nodeflowData=e,this.store=_({heldKeys:new Set})}get heldKeys(){return this.store[0].heldKeys}set heldKeys(e){this.store[1]({heldKeys:e})}releaseKey(e){this.store[1](Re(o=>o.heldKeys.delete(e)))}clearKeys(){this.store[1]({heldKeys:new Set})}pressKey(e){this.store[1](Re(o=>o.heldKeys.add(e)))}hasKeyPressed(e){return this.heldKeys.has(e)}isActionPressed(e){return!se(he(this.heldKeys,e))}}var p=(t=>(t.Connector="connector",t.Node="node",t.Nodeflow="nodeflow",t.Connection="connection",t))(p||{});class D{constructor(e){f(this,"connectorsMap",new j),f(this,"nodesMap",new j),f(this,"connectionsMap",new j),f(this,"nodeflowData"),f(this,"_hasSelectedNodeflow",!1),this.nodeflowData=e}static createHash(e){switch(e.type){case p.Connector:return`${e.connector.parentNode.id}-${e.connector.id}`;case p.Node:return`${e.node.id}`;case p.Connection:return`${e.connection.sourceConnector.parentNode.id}-${e.connection.sourceConnector.id}-${e.connection.destinationConnector.parentNode.id}-${e.connection.destinationConnector.id}`;default:return p.Nodeflow}}addNode(e){const o=D.createHash({node:e,type:p.Node});return this.nodesMap.set(o,e)}addConnector(e){const o=D.createHash({connector:e,type:p.Connector});return this.connectorsMap.set(o,e)}addConnection(e){const o=D.createHash(e);return this.connectionsMap.set(o,e)}addNodeflow(){return this._hasSelectedNodeflow=!0,this}add(e){switch(e.type){case p.Connector:return this.addConnector(e.connector);case p.Node:return this.addNode(e.node);case p.Connection:return this.addConnection(e);default:return this.addNodeflow()}}delete(e){const o=D.createHash(e);switch(e.type){case p.Connector:return this.connectorsMap.delete(o);case p.Node:return this.nodesMap.delete(o);case p.Connection:return this.connectionsMap.delete(o);default:return this._hasSelectedNodeflow=!1,this}}has(e){const o=D.createHash(e);switch(e.type){case p.Connector:return this.connectorsMap.has(o);case p.Node:return this.nodesMap.has(o);case p.Connection:return this.connectionsMap.has(o);default:return this._hasSelectedNodeflow}}get(e){const o=D.createHash(e);switch(e.type){case p.Connector:return this.connectorsMap.get(o);case p.Node:return this.nodesMap.get(o);case p.Connection:return this.connectionsMap.get(o);default:return this.nodeflowData}}static serialize(e){switch(e.type){case p.Connector:return{connectorId:e.connector.id,nodeId:e.connector.parentNode.id,type:p.Connector};case p.Node:return{nodeId:e.node.id,type:p.Node};case p.Connection:return{connection:{destinationConnectorId:e.connection.destinationConnector.id,destinationNodeId:e.connection.destinationConnector.parentSection.parentNode.id,sourceConnectorId:e.connection.sourceConnector.id,sourceNodeId:e.connection.sourceConnector.parentNode.id},type:p.Connection};default:return{type:p.Nodeflow}}}static deserialize(e,o){switch(e.type){case p.Connector:{const n=o.nodes.get(e.nodeId);if(!n)throw new Error("Node not found");const s=n.getConnector(e.connectorId);if(!s)throw new Error("Connector not found");return{connector:s,type:p.Connector}}case p.Node:{const n=o.nodes.get(e.nodeId);if(!n)throw new Error("Node not found");return{node:n,type:p.Node}}case p.Connection:{const n=o.nodes.get(e.connection.sourceNodeId);if(!n)throw new Error("Source node not found");const s=n.getConnector(e.connection.sourceConnectorId);if(!s)throw new Error("Source connector not found");const i=o.nodes.get(e.connection.destinationNodeId);if(!i)throw new Error("Destination node not found");const r=i.getConnector(e.connection.destinationConnectorId);if(!r)throw new Error("Destination connector not found");return{connection:{destinationConnector:r,sourceConnector:s},type:p.Connection}}default:return{type:p.Nodeflow}}}toObject(){const e={};return this.connectorsMap.forEach(o=>{e[D.createHash({connector:o,type:p.Connector})]=D.serialize({connector:o,type:p.Connector})}),this.nodesMap.forEach(o=>{e[D.createHash({node:o,type:p.Node})]=D.serialize({node:o,type:p.Node})}),this.connectionsMap.forEach(o=>{e[D.createHash(o)]=D.serialize(o)}),this._hasSelectedNodeflow&&(e[p.Nodeflow]={type:p.Nodeflow}),e}static fromObject(e,o){const n=new D(o);for(const s in e){const i=e[s];switch(i.type){case p.Connector:case p.Node:case p.Connection:n.add(D.deserialize(i,o));break;default:n._hasSelectedNodeflow=!0;break}}return n}get selectedConnectors(){return Array.from(this.connectorsMap.values())}get selectedNodes(){return Array.from(this.nodesMap.values())}get selectedNodesMap(){return this.nodesMap}get selectedConnections(){return Array.from(this.connectionsMap.values())}get selectedNodeflow(){return this._hasSelectedNodeflow}hasSelectedNodeflow(){return this._hasSelectedNodeflow}clearConnectors(){this.connectorsMap.clear()}clearNodes(){this.nodesMap.clear()}clearConnections(){this.connectionsMap.clear()}clearNodeflow(){this._hasSelectedNodeflow=!1}clear(){this.clearConnectors(),this.clearNodes(),this.clearConnections(),this.clearNodeflow()}isNodeSelected(e){return this.nodesMap.has(e)}isConnectorSelected(e,o){return this.connectorsMap.has(`${o}-${e}`)}isConnectionSelected(e,o,n,s){return this.connectionsMap.has(`${e}-${o}-${n}-${s}`)}deleteNodes(e){for(const o of this.nodesMap.values())e(o)&&this.nodesMap.delete(o.id)}deleteConnectors(e){for(const o of this.connectorsMap.values())e(o)&&this.connectorsMap.delete(`${o.parentNode.id}-${o.id}`)}deleteConnections(e){for(const o of this.connectionsMap.values())e(o)&&this.connectionsMap.delete(`${o.connection.sourceConnector.parentNode.id}-${o.connection.sourceConnector.id}-${o.connection.destinationConnector.parentNode.id}-${o.connection.destinationConnector.id}`)}get size(){return this.connectorsMap.size+this.nodesMap.size+this.connectionsMap.size+(this._hasSelectedNodeflow?1:0)}}class B{constructor(e,o,n,s){f(this,"position"),f(this,"size"),this.position=h.of(e,o),this.size=h.of(n,s)}static of(e,o){return new B(e.x,e.y,o.x,o.y)}static fromRect(e){return new B(e.position.x,e.position.y,e.size.x,e.size.y)}static fromPositions(e,o){return B.of(e,o.subtract(e))}copy(){return B.fromRect(this)}get center(){return this.position.add(this.size.divideBy(2))}intersects(e){return this.position.x<e.position.x+e.size.x&&this.position.x+this.size.x>e.position.x&&this.position.y<e.position.y+e.size.y&&this.position.y+this.size.y>e.position.y}startPosition(){return h.of(Math.min(this.position.x,this.position.x+this.size.x),Math.min(this.position.y,this.position.y+this.size.y))}endPosition(){return h.of(Math.max(this.position.x,this.position.x+this.size.x),Math.max(this.position.y,this.position.y+this.size.y))}}class st{constructor(e){f(this,"store"),f(this,"nodeflowData"),this.nodeflowData=e,this.store=_({boundingBox:void 0,selections:new D(this.nodeflowData)})}get boundingBox(){return this.store[0].boundingBox}set boundingBox(e){if(this.store[1]({boundingBox:e}),!e){this.selections.selectedNodes.forEach(i=>{this.nodeflowData.mouseData.selections.add({type:p.Node,node:i})}),this.selections.clear();return}const o=B.of(e.position,e.size),n=B.fromPositions(this.nodeflowData.transformVec2ToCanvas(o.startPosition()),this.nodeflowData.transformVec2ToCanvas(o.endPosition())),s=this.nodeflowData.chunking.getNodesInRect(n);this.selections.clear(),s.forEach(i=>{this.selections.add({type:p.Node,node:i})})}get selections(){return this.store[0].selections}}class uo{constructor(e){f(this,"store"),f(this,"nodeflowData"),f(this,"selectNode",(o,n,s=!0)=>{if(!this.nodeflowData.nodes.has(o))return;const i=this.nodeflowData.nodes.get(o);this.hasSelectedNode(o)&&this.selections.delete({type:p.Node,node:i}),this.selections.addNode(i),this.update({pointerDown:s,mousePosition:n,clickStartPosition:n.divideBy(this.nodeflowData.zoomLevel).subtract(this.nodeflowData.nodes.get(o).position)})}),f(this,"clearSelections",()=>{this.selections.clear(),this.nodeflowData.resetMovement()}),f(this,"startCreatingConnection",(o,n,s)=>{if(!this.nodeflowData.settings.canCreateConnections)return;const i=this.nodeflowData.nodes.get(o);if(!i)return;const r=i.getConnector(s);if(!r)return;const c=new D(this.nodeflowData);c.add({connector:r,type:p.Connector}),this.update({pointerDown:!0,selections:c,mousePosition:n,clickStartPosition:n.divideBy(this.nodeflowData.zoomLevel).subtract(i.position)})}),f(this,"globalMousePosition",()=>this.nodeflowData.transformVec2ToCanvas(this.mousePosition)),this.nodeflowData=e,this.store=_({clickStartPosition:void 0,mousePosition:h.zero(),heldMouseButtons:new Set,pointerDown:!1,selections:new D(this.nodeflowData),selectionBox:new st(this.nodeflowData)})}serialize(){var e;return{clickStartPosition:(e=this.clickStartPosition)==null?void 0:e.serialize(),selections:this.selections.toObject()}}deserialize(e){this.update({clickStartPosition:h.deserializeOrDefault(e.clickStartPosition),selections:D.fromObject(e.selections,this.nodeflowData)})}get clickStartPosition(){return this.store[0].clickStartPosition}get heldMouseButtons(){return this.store[0].heldMouseButtons}get selections(){return this.store[0].selections}get selectionBox(){return this.store[0].selectionBox}get mousePosition(){return this.store[0].mousePosition}get heldConnections(){return this.selections.selectedConnections}get heldConnectors(){return this.selections.selectedConnectors}get heldNodes(){return this.selections.selectedNodes}isHoldingButton(e){return this.heldMouseButtons.has(e)}deleteNodes(e){this.selections.deleteNodes(e)}deleteConnectors(e){this.selections.deleteConnectors(e)}deleteConnections(e){this.selections.deleteConnections(e)}set clickStartPosition(e){this.store[1]({clickStartPosition:e})}set mousePosition(e){this.store[1]({mousePosition:e})}set pointerDown(e){this.store[1]({pointerDown:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}reset(){this.update({clickStartPosition:void 0,pointerDown:!1,heldMouseButtons:new Set,selections:new D(this.nodeflowData),selectionBox:new st(this.nodeflowData)})}selectNodeflow(){this.hasSelectedNodeflow()&&this.selections.clearNodeflow(),this.selections.addNodeflow()}hasSelectedNodeflow(){return this.selections.hasSelectedNodeflow()}hasSelectedNode(e){return this.selections.isNodeSelected(e)}hasSelectedConnector(e,o){return this.selections.isConnectorSelected(e,o)}hasSelectedConnection(e,o,n,s){return this.selections.isConnectionSelected(e,o,n,s)}}class ho{constructor(e,o=2048){f(this,"store"),f(this,"nodeflowData"),this.nodeflowData=e,this.store=_({chunkSize:o,chunks:new j})}get chunkSize(){return this.store[0].chunkSize}set chunkSize(e){this.store[1]({chunkSize:e})}get chunks(){return this.store[0].chunks}set chunks(e){this.store[1]({chunks:e})}addNodeToChunk(e,o){const n=this.calculateChunkPosition(o).hashCode(),s=this.chunks.get(n)||new Set;s.add(e),this.chunks.set(n,s)}removeNodeFromChunk(e,o){const n=this.calculateChunkPosition(o).hashCode(),s=this.chunks.get(n);s&&(s.delete(e),this.chunks.set(n,s))}updateNodeInChunk(e,o,n){const s=this.calculateChunkPosition(o).hashCode(),i=this.calculateChunkPosition(n).hashCode();if(s==i)return;const r=this.chunks.get(s),c=this.chunks.get(i)||new Set;r&&(r.delete(e),this.chunks.set(s,r),se(r)&&this.chunks.delete(s)),c&&(c.add(e),this.chunks.set(i,c))}getChunk(e){return this.chunks.get(this.calculateChunkPosition(e).hashCode())||new Set}calculateChunkPosition(e){return h.of(Math.floor(e.x/this.chunkSize),Math.floor(e.y/this.chunkSize))}checkForCollisions(e){if(!this.nodeflowData.settings.allowCollision)return[];const o=this.nodeflowData.nodes.get(e),n=[];if(!o)return n;for(let s=-1;s<2;++s)for(let i=-1;i<2;++i){const r=this.getChunk(o.rectWithOffset.position.add(h.of(s*this.chunkSize,i*this.chunkSize)));r.size>0&&n.push(...r)}return n.filter(s=>{const i=this.nodeflowData.nodes.get(s);return i?.id==o.id?!1:i&&i.id!=o.id&&i.rectWithOffset.intersects(o.rectWithOffset)})}getNodesInRect(e){const o=[],n=e.startPosition(),s=e.endPosition(),i=this.calculateChunkPosition(n),r=this.calculateChunkPosition(s);for(let c=i.x;c<=r.x;++c)for(let a=i.y;a<=r.y;++a){const d=this.chunks.get(h.of(c,a).hashCode());d&&d.forEach(u=>{const l=this.nodeflowData.nodes.get(u);l&&e.intersects(l.rectWithOffset)&&o.push(l)})}return o}}const $e=(t,e,o)=>Math.min(Math.max(t,e),o);class Ve{constructor(e,o){f(this,"store"),f(this,"nodeflowData"),this.nodeflowData=e,this.store=_(o),this.nodeflowData.chunking.addNodeToChunk(this.id,this.getCenter()),fe(()=>{const n=this.getCollidingNodes();n.length>0&&fe(()=>{n.forEach(s=>{const i=this.nodeflowData.nodes.get(s);if(i){const r=i.rectWithOffset,c=this.rectWithOffset;if(r.intersects(c)){const a=r.center.subtract(c.center).magnitude,d=r.center.subtract(c.center).normalize();this.position=this.position.subtract(d.multiplyBy(a))}}})})})}get nodeflow(){return this.nodeflowData}get centered(){return this.store[0].centered}get connectorSections(){return this.store[0].connectorSections}get css(){return this.store[0].css}get customData(){return this.store[0].customData}get display(){return this.store[0].display}get id(){return this.store[0].id}get offset(){return this.store[0].offset}get position(){return this.store[0].position}get ref(){return this.store[0].ref}get resizeObserver(){return this.store[0].resizeObserver}get size(){return this.store[0].size}set centered(e){this.store[1]({centered:e})}set connectorSections(e){this.store[1]({connectorSections:e})}set css(e){this.store[1]({css:e})}set customData(e){this.store[1]({customData:e})}set display(e){this.store[1]({display:e})}set id(e){this.store[1]({id:e})}set offset(e){this.store[1]({offset:e})}set position(e){const o=this.position;this.store[1]({position:e}),this.nodeflowData.chunking.updateNodeInChunk(this.id,o,e)}set ref(e){this.store[1]({ref:e})}set resizeObserver(e){this.store[1]({resizeObserver:e})}set size(e){this.store[1]({size:e})}get sizeWithOffset(){return this.size.add(this.offset)}update(e){this.store[1](e)}serialize(){const e=Array.from(this.connectorSections.values()).reduce((o,n)=>(o[n.id]=n.serialize(),o),{});return{centered:this.centered,connectorSections:e,css:G(this.css),customData:G(this.customData),id:this.id,display:this.display,position:this.position.serialize()}}static deserialize(e,o,n=!0){const s=o.id??e.getNextFreeNodeId(),i=new Ve(e,{centered:o.centered??!1,connectorSections:new j,css:G(o.css)??{},customData:G(o.customData)??{},display:o.display??(()=>{}),id:s,offset:h.zero(),position:h.deserializeOrDefault(o.position),ref:void 0,resizeObserver:void 0,size:h.zero()}),r=k.evaluateHistoryGroup(n);return Object.entries(o.connectorSections??[]).forEach(([c,a])=>{i.addConnectorSection({css:a.css,id:c,connectors:a.connectors},r)}),i}serializeConnections(){return Array.from(this.connectorSections.values()).flatMap(e=>Array.from(e.connectors.values()).flatMap(o=>o.serializeConnections()))}updateWithPrevious(e){this.store[1](e)}addConnectorSection(e,o=!0){const n=k.evaluateHistoryGroup(o),s=je.deserialize(e,this,n);if(this.connectorSections.has(s.id))return this.connectorSections.get(s.id);if(n){const i=s.serialize(),r=this.nodeflowData.id,c=this.id,a=i.id;this.nodeflowData.changes.addChange({type:"remove",source:"connector-section",applyChange:()=>{var d,u;(u=(d=N.get().getNodeflow(r))==null?void 0:d.nodes.get(c))==null||u.addConnectorSection(i,!1)},undoChange:()=>{var d,u;(u=(d=N.get().getNodeflow(r))==null?void 0:d.nodes.get(c))==null||u.removeConnectorSection(a,!1)},historyGroup:n})}return this.connectorSections.set(s.id,s),s}removeConnectorSection(e,o=!0){if(!this.connectorSections.has(e))return;const n=this.connectorSections.get(e),s=k.evaluateHistoryGroup(o);if(s){const i=n.serialize(),r=this.nodeflowData.id,c=this.id;this.nodeflowData.changes.addChange({type:"remove",source:"connector-section",applyChange:()=>{var a,d;(d=(a=N.get().getNodeflow(r))==null?void 0:a.nodes.get(c))==null||d.removeConnectorSection(e,!1)},undoChange:()=>{var a,d;(d=(a=N.get().getNodeflow(r))==null?void 0:a.nodes.get(c))==null||d.addConnectorSection(i,!1)},historyGroup:s})}this.connectorSections.delete(e)}getConnectorCount(){return Array.from(this.connectorSections.values()).reduce((e,o)=>e+o.connectors.size,0)}addConnector(e,o,n=!0){if(this.connectorSections.has(e))return this.connectorSections.get(e).addConnector(o,n)}removeConnector(e,o,n=!0){this.connectorSections.has(e)&&this.connectorSections.get(e).removeConnector(o,n)}getConnector(e){var o;return(o=this.getSectionFromConnector(e))==null?void 0:o.connectors.get(e)}getTotalConnectedInputs(e){var o;return((o=this.getConnector(e))==null?void 0:o.sources.length)??0}getAllConnectors(){return Array.from(this.connectorSections.values()).reduce((e,o)=>e.concat(Array.from(o.connectors.values())),[])}getNextFreeConnectorSectionId(){let e="0";for(let o=1;this.connectorSections.has(e);++o)e=o.toString();return e}getNextFreeConnectorId(){let e="0";for(let o=1;Array.from(this.connectorSections.values()).some(n=>n.connectors.has(e));++o)e=o.toString();return e}removeIncomingConnections(){this.connectorSections.forEach(e=>e.removeIncomingConnections())}removeOutgoingConnections(){this.connectorSections.forEach(e=>e.removeOutgoingConnections())}getAllSourceConnectors(){return Array.from(this.connectorSections.values()).reduce((e,o)=>e.concat(o.getSourceConnectors()),[])}getAllDestinationConnectors(){return Array.from(this.connectorSections.values()).reduce((e,o)=>e.concat(o.getDestinationConnectors()),[])}getAllSourceConnections(){return this.getAllSourceConnectors().map(e=>e.destinations.filter(o=>o.destinationConnector.parentNode.id===this.id).map(o=>({sourceNodeId:e.parentNode.id,sourceConnectorId:e.id,destinationNodeId:o.destinationConnector.parentNode.id,destinationConnectorId:o.destinationConnector.id,css:o.css}))).flat()}getAllDestinationConnections(){return this.getAllDestinationConnectors().map(e=>e.sources.filter(o=>o.sourceConnector.parentNode.id===this.id).map(o=>({sourceNodeId:o.sourceConnector.parentNode.id,sourceConnectorId:o.sourceConnector.id,destinationNodeId:e.parentNode.id,destinationConnectorId:e.id}))).flat()}getAllSourceNodes(){return this.getAllSourceConnectors().map(e=>e.parentNode)}getAllDestinationNodes(){return this.getAllDestinationConnectors().map(e=>e.parentNode)}getSectionFromConnector(e){return Array.from(this.connectorSections.values()).find(o=>o.connectors.get(e))}getCenter(){return this.position.add(this.offset,this.size.divideBy(2))}select(e){this.nodeflowData.selectNode(this.id,e)}get rect(){return B.of(this.position,this.size)}get rectWithOffset(){return B.of(this.position.subtract(this.offset),this.size.add(this.offset.multiplyBy(2)))}getCollidingNodes(){return this.nodeflowData.chunking.checkForCollisions(this.id)}isColliding(){return this.getCollidingNodes().length>0}}var K=(t=>(t[t.LEFT=0]="LEFT",t[t.MIDDLE=1]="MIDDLE",t[t.RIGHT=2]="RIGHT",t[t.BACK=3]="BACK",t[t.FORWARD=4]="FORWARD",t))(K||{}),y=(t=>(t.ALT_LEFT="AltLeft",t.ALT_RIGHT="AltRight",t.ARROW_DOWN="ArrowDown",t.ARROW_LEFT="ArrowLeft",t.ARROW_RIGHT="ArrowRight",t.ARROW_UP="ArrowUp",t.BACKQUOTE="Backquote",t.BACKSLASH="Backslash",t.BACKSPACE="Backspace",t.BRACKET_LEFT="BracketLeft",t.BRACKET_RIGHT="BracketRight",t.CAPS_LOCK="CapsLock",t.COMMA="Comma",t.CONTEXT_MENU="ContextMenu",t.CONTROL_LEFT="ControlLeft",t.CONTROL_RIGHT="ControlRight",t.DELETE="Delete",t.DIGIT_0="Digit0",t.DIGIT_1="Digit1",t.DIGIT_2="Digit2",t.DIGIT_3="Digit3",t.DIGIT_4="Digit4",t.DIGIT_5="Digit5",t.DIGIT_6="Digit6",t.DIGIT_7="Digit7",t.DIGIT_8="Digit8",t.DIGIT_9="Digit9",t.END="End",t.ENTER="Enter",t.EQUAL="Equal",t.ESCAPE="Escape",t.F1="F1",t.F10="F10",t.F11="F11",t.F12="F12",t.F2="F2",t.F3="F3",t.F4="F4",t.F5="F5",t.F6="F6",t.F7="F7",t.F8="F8",t.F9="F9",t.HOME="Home",t.INSERT="Insert",t.KEY_A="KeyA",t.KEY_B="KeyB",t.KEY_C="KeyC",t.KEY_D="KeyD",t.KEY_E="KeyE",t.KEY_F="KeyF",t.KEY_G="KeyG",t.KEY_H="KeyH",t.KEY_I="KeyI",t.KEY_J="KeyJ",t.KEY_K="KeyK",t.KEY_L="KeyL",t.KEY_M="KeyM",t.KEY_N="KeyN",t.KEY_O="KeyO",t.KEY_P="KeyP",t.KEY_Q="KeyQ",t.KEY_R="KeyR",t.KEY_S="KeyS",t.KEY_T="KeyT",t.KEY_U="KeyU",t.KEY_V="KeyV",t.KEY_W="KeyW",t.KEY_X="KeyX",t.KEY_Y="KeyY",t.KEY_Z="KeyZ",t.META_LEFT="MetaLeft",t.META_RIGHT="MetaRight",t.MINUS="Minus",t.NUMPAD_0="Numpad0",t.NUMPAD_1="Numpad1",t.NUMPAD_2="Numpad2",t.NUMPAD_3="Numpad3",t.NUMPAD_4="Numpad4",t.NUMPAD_5="Numpad5",t.NUMPAD_6="Numpad6",t.NUMPAD_7="Numpad7",t.NUMPAD_8="Numpad8",t.NUMPAD_9="Numpad9",t.NUMPAD_ADD="NumpadAdd",t.NUMPAD_COMMA="NumpadComma",t.NUMPAD_DECIMAL="NumpadDecimal",t.NUMPAD_DIVIDE="NumpadDivide",t.NUMPAD_ENTER="NumpadEnter",t.NUMPAD_EQUAL="NumpadEqual",t.NUMPAD_MULTIPLY="NumpadMultiply",t.NUMPAD_SUBTRACT="NumpadSubtract",t.NUM_LOCK="NumLock",t.PAGE_DOWN="PageDown",t.PAGE_UP="PageUp",t.PERIOD="Period",t.QUOTE="Quote",t.SCROLL_LOCK="ScrollLock",t.SEMICOLON="Semicolon",t.SHIFT_LEFT="ShiftLeft",t.SHIFT_RIGHT="ShiftRight",t.SLASH="Slash",t.SPACE="Space",t.TAB="Tab",t))(y||{});const Nt=class St{constructor(e,o={},n){f(this,"store"),f(this,"changes"),f(this,"mouseData"),f(this,"keyboardData"),f(this,"curveFunctions"),f(this,"settingsStore"),f(this,"nodes"),f(this,"eventStore"),f(this,"chunking"),f(this,"id"),f(this,"keymap",{MOVE_DOWN:new Set([y.ARROW_DOWN,y.KEY_S]),MOVE_LEFT:new Set([y.ARROW_LEFT,y.KEY_A]),MOVE_RIGHT:new Set([y.ARROW_RIGHT,y.KEY_D]),MOVE_UP:new Set([y.ARROW_UP,y.KEY_W]),SELECT_MULTIPLE:new Set([y.CONTROL_LEFT,y.CONTROL_RIGHT]),CREATE_SELECTION_BOX:new Set([y.SHIFT_LEFT,y.SHIFT_RIGHT])}),f(this,"resetMovement",()=>{this.currentMoveSpeed=h.zero(),this.keymap.MOVE_LEFT.forEach(s=>this.keyboardData.releaseKey(s)),this.keymap.MOVE_RIGHT.forEach(s=>this.keyboardData.releaseKey(s)),this.keymap.MOVE_UP.forEach(s=>this.keyboardData.releaseKey(s)),this.keymap.MOVE_DOWN.forEach(s=>this.keyboardData.releaseKey(s))}),f(this,"updateZoom",(s,i)=>{const r=this.zoomLevel;if(s===0)return;const c=Number($e(s>0?r+r*s*this.settings.zoomMultiplier:r/(1-s*this.settings.zoomMultiplier),this.settings.minZoom,this.settings.maxZoom).toFixed(4));this.mouseData.pointerDown=!1;const a=this.size,d=i.subtract(this.startPosition),u=a.multiplyBy(r),l=a.multiplyBy(c),g=d.subtract(u.divideBy(2)).divideBy(r),v=d.subtract(l.divideBy(2)).divideBy(c);this.updateWithPrevious(w=>({position:w.position.subtract(g).add(v),zoomLevel:c}))}),this.id=e,this.settingsStore=_({...St.DEFAULT_SETTINGS,...o}),this.curveFunctions=n?.(this)??new wt(this),this.store=_({currentMoveSpeed:h.zero(),position:h.zero(),startPosition:h.zero(),size:h.zero(),zoomLevel:1,pinchDistance:0,intervalId:void 0}),this.changes=new k,this.mouseData=new uo(this),this.keyboardData=new lo(this),this.nodes=new j,this.chunking=new ho(this),this.eventStore={onKeyDownInNodeflow:new P(this),onKeyUpInNodeflow:new P(this),onMouseDownInConnector:new P(this),onMouseDownInNode:new P(this),onMouseDownInNodeflow:new P(this),onMouseMoveInNodeflow:new P(this),onNodeConnected:new P(this),onNodeDataChanged:new P(this),onPointerDownInNodeCurve:new P(this),onPointerUpInConnector:new P(this),onPointerUpInNode:new P(this),onPointerUpInNodeflow:new P(this),onTouchMoveInNodeflow:new P(this),onTouchStartInConnector:new P(this),onTouchStartInNode:new P(this),onTouchStartInNodeflow:new P(this),onWheelInNodeflow:new P(this)},this.setupDefaultEventHandlers()}handleMovement(){const e=!se(he(this.keyboardData.heldKeys,this.keymap.MOVE_LEFT)),o=!se(he(this.keyboardData.heldKeys,this.keymap.MOVE_RIGHT)),n=!se(he(this.keyboardData.heldKeys,this.keymap.MOVE_UP)),s=!se(he(this.keyboardData.heldKeys,this.keymap.MOVE_DOWN)),i=this.mouseData.heldNodes.length>0;this.currentMoveSpeed=h.of(this.calculateDirectionalMovementAmount(e||o,this.currentMoveSpeed.x,o,e,!i),this.calculateDirectionalMovementAmount(n||s,this.currentMoveSpeed.y,s,n,!i)),!(this.currentMoveSpeed.x===0&&this.currentMoveSpeed.y===0)&&(i?this.updateHeldNodePosition(this.currentMoveSpeed.divideBy(this.zoomLevel)):this.updateBackgroundPosition(this.currentMoveSpeed,!0))}serialize(){return{changes:this.changes.serialize(),connections:this.serializeConnections(),currentMoveSpeed:this.currentMoveSpeed.serialize(),mouseData:this.mouseData.serialize(),nodes:Object.fromEntries(Array.from(this.nodes.entries()).map(([e,o])=>[e,o.serialize()])),pinchDistance:this.pinchDistance,position:this.position.serialize(),size:this.size.serialize(),startPosition:this.startPosition.serialize(),zoomLevel:this.zoomLevel}}deserialize(e,o=!1){this.update({currentMoveSpeed:h.deserializeOrDefault(e.currentMoveSpeed),pinchDistance:e.pinchDistance,position:h.deserializeOrDefault(e.position),size:h.deserializeOrDefault(e.size),startPosition:h.deserializeOrDefault(e.startPosition),zoomLevel:e.zoomLevel});const n=k.evaluateHistoryGroup(o);this.nodes.clear(),Object.values(e.nodes).forEach(s=>{this.addNode(s,n)}),this.mouseData.deserialize(e.mouseData),e.connections.forEach(s=>{this.addConnection(s,n)}),this.changes.deserialize(e.changes)}serializeConnections(){return Array.from(this.nodes.values()).flatMap(e=>e.serializeConnections())}get settings(){return this.settingsStore[0]}updateSettings(e){this.settingsStore[1](e)}get currentMoveSpeed(){return this.store[0].currentMoveSpeed}get position(){return this.store[0].position}get startPosition(){return this.store[0].startPosition}get size(){return this.store[0].size}get zoomLevel(){return this.store[0].zoomLevel}get pinchDistance(){return this.store[0].pinchDistance}get intervalId(){return this.store[0].intervalId}set currentMoveSpeed(e){this.store[1]({currentMoveSpeed:e})}set position(e){this.store[1]({position:e})}set startPosition(e){this.store[1]({startPosition:e})}set size(e){this.store[1]({size:e})}set zoomLevel(e){this.store[1]({zoomLevel:e})}set pinchDistance(e){this.store[1]({pinchDistance:e})}set intervalId(e){this.store[1]({intervalId:e})}update(e){this.store[1](e)}updateWithPrevious(e){this.store[1](e)}center(){const e=this.size.divideBy(2);return this.startPosition.add(e).divideBy(this.zoomLevel).subtract(this.position)}calculateDirectionalMovementAmount(e,o,n,s,i=!1){let r=o;if(e){const c=this.settings.movementAcceleration*(i?-1:1);r=$e(r+(n?c:0)-(s?c:0),-this.settings.maxMovementSpeed,this.settings.maxMovementSpeed)}else r=$e(r*this.settings.movementDeceleration,-this.settings.maxMovementSpeed,this.settings.maxMovementSpeed);return Math.abs(r)<.1&&(r=0),r}updateBackgroundPosition(e,o=!1){!this.settings.canPan||!this.mouseData.hasSelectedNodeflow()||o===(this.mouseData.isHoldingButton(K.MIDDLE)||this.mouseData.isHoldingButton(K.LEFT))||this.mouseData.selectionBox.boundingBox||this.updateWithPrevious(n=>({position:n.position.add(e.divideBy(this.zoomLevel))}))}addNode(e,o=!0){const n=k.evaluateHistoryGroup(o),s=Ve.deserialize(this,e,n);if(this.nodes.set(s.id,s),n){const i=s.serializeConnections(),r=s.serialize(),c=this.id;this.changes.addChange({type:"add",source:"node",applyChange:()=>{const a=N.get().getNodeflow(c);a?.addNode(r,!1),i.forEach(d=>{a?.addConnection(d,!1)})},undoChange:()=>{var a;(a=N.get().getNodeflow(c))==null||a.removeNode(s.id,!1)},historyGroup:n})}return s}updateNode(e,o,n=!0){if(!this.nodes.has(e))return;const s=this.nodes.get(e),i=k.evaluateHistoryGroup(n);if(i){const r=this.nodes.get(e),c=r.serialize(),a=r.serializeConnections(),d=this.id,u=Object.entries(c).reduce((l,[g,v])=>(g in o&&Object.assign(l,{[g]:G(v)}),l),{});this.changes.addChange({type:"update",source:"node",applyChange:()=>{var l;(l=N.get().getNodeflow(d))==null||l.updateNode(e,o,!1)},undoChange:()=>{const l=N.get().getNodeflow(d);l?.updateNode(e,u,!1),a.forEach(g=>{l?.addConnection(g,!1)})},historyGroup:i})}s.updateWithPrevious(Re(r=>Object.assign(r,o))),this.eventStore.onNodeDataChanged.publish({nodeId:e,data:o})}removeNode(e,o=!0){if(!this.nodes.has(e))return;this.mouseData.selections.deleteNodes(s=>s.id===e);const n=k.evaluateHistoryGroup(o);if(n){const s=this.nodes.get(e),i=s.serializeConnections(),r=this.id;this.changes.addChange({type:"remove",source:"node",applyChange:()=>{var c;(c=N.get().getNodeflow(r))==null||c.removeNode(e,!1)},undoChange:()=>{const c=N.get().getNodeflow(r);c?.addNode(s.serialize(),!1),i.forEach(a=>{c?.addConnection(a,!1)})},historyGroup:n})}this.removeIncomingConnections(e),this.removeOutgoingConnections(e),this.nodes.delete(e)}removeIncomingConnections(e){this.nodes.has(e)&&this.nodes.get(e).connectorSections.forEach(o=>{o.connectors.forEach(n=>{n.sources.forEach(({sourceConnector:s})=>{s.destinations.filterInPlace(({destinationConnector:i})=>i.parentNode.id!==e)}),n.sources=new ne})})}removeOutgoingConnections(e){this.nodes.has(e)&&this.nodes.get(e).connectorSections.forEach(o=>{o.connectors.forEach(n=>{n.destinations.forEach(({destinationConnector:s})=>{s.sources.filterInPlace(({sourceConnector:i})=>i.parentNode.id!==e)}),n.destinations=new ne})})}getAllSourceConnectors(e){return this.nodes.has(e)?this.nodes.get(e).getAllSourceConnectors():[]}getAllDestinationConnectors(e){return this.nodes.has(e)?this.nodes.get(e).getAllDestinationConnectors():[]}getAllSourceConnections(e){return this.nodes.has(e)?this.nodes.get(e).getAllSourceConnections():[]}getAllDestinationConnections(e){return this.nodes.has(e)?this.nodes.get(e).getAllDestinationConnections():[]}getNextFreeNodeId(){let e="0";for(let o=1;this.nodes.has(e);++o)e=o.toString();return e}addConnection(e,o=!0){const{sourceNodeId:n,sourceConnectorId:s,destinationNodeId:i,destinationConnectorId:r,css:c}=e;if(!this.nodes.has(n)||!this.nodes.has(i))return;const a=this.nodes.get(n),d=this.nodes.get(i),u=a.getConnector(s),l=d.getConnector(r);if(!u||!l||u.destinations.some(v=>v.destinationConnector===l))return;const g=k.evaluateHistoryGroup(o);if(g){const v=this.id;this.changes.addChange({type:"add",source:"connection",applyChange:()=>this.addConnection(e,!1),undoChange:()=>{var w;return(w=N.get().getNodeflow(v))==null?void 0:w.removeConnection(n,s,i,r,!1)},historyGroup:g})}u.destinations.push(new io({destinationConnector:l,css:c??{}})),l.sources.push(new ao({sourceConnector:u}))}removeConnection(e,o,n,s,i=!0){var r;if(!this.nodes.has(e)||!this.nodes.has(n))return;const c=this.nodes.get(e),a=this.nodes.get(n),d=c.getConnector(o),u=a.getConnector(s);if(!d||!u)return;const l=k.evaluateHistoryGroup(i);if(l){const g=(r=d.destinations.find(T=>T.destinationConnector.parentNode.id===n))==null?void 0:r.css,v=this.id,w=()=>{var T;(T=N.get().getNodeflow(v))==null||T.addConnection({sourceNodeId:e,sourceConnectorId:o,destinationNodeId:n,destinationConnectorId:s,css:g},!1)},A=()=>{var T;(T=N.get().getNodeflow(v))==null||T.removeConnection(e,o,n,s,!1)};this.changes.addChange({type:"remove",source:"connection",applyChange:A,undoChange:w,historyGroup:l})}d.destinations.filterInPlace(g=>g.destinationConnector.parentNode.id!==n),u.sources.filterInPlace(g=>g.sourceConnector.parentNode.id!==e)}updateHeldNodePosition(e){!this.settings.canMoveNodes||this.mouseData.selectionBox.boundingBox||this.mouseData.heldNodes.forEach(o=>o.position=o.position.add(e))}setHeldNodePosition(e){!this.settings.canMoveNodes||this.mouseData.selectionBox.boundingBox||this.mouseData.heldNodes.forEach(o=>o.position=e)}setupDefaultEventHandlers(){this.eventStore.onNodeConnected.subscribeMultiple([{name:"nodeflow:create-connection",event:e=>this.addConnection({sourceNodeId:e.inputNodeId,sourceConnectorId:e.inputId,destinationNodeId:e.outputNodeId,destinationConnectorId:e.outputId})},{name:"nodeflow:reset-mouse-data",event:()=>this.mouseData.reset()}]),this.eventStore.onMouseMoveInNodeflow.subscribeMultiple([{name:"nodeflow:drag-node",event:({event:e})=>{this.mouseData.heldNodes.length===0||!this.mouseData.pointerDown&&!this.mouseData.isHoldingButton(K.LEFT)||this.mouseData.selectionBox.boundingBox||this.updateHeldNodePosition(h.of(e.movementX,e.movementY).divideBy(this.zoomLevel))}},{name:"nodeflow:update-background-position",event:({event:e})=>{const o=this.mouseData.heldNodes.length>0&&(this.mouseData.pointerDown||this.mouseData.isHoldingButton(K.LEFT));this.mouseData.selectionBox.boundingBox||o||this.updateBackgroundPosition(h.of(e.movementX,e.movementY))}},{name:"nodeflow:expand-selection-box",event:({event:e})=>{this.mouseData.selectionBox.boundingBox&&(this.mouseData.selectionBox.boundingBox=B.of(this.mouseData.selectionBox.boundingBox.position,this.mouseData.selectionBox.boundingBox.position.subtract(h.fromEvent(e)).negate()))}}]),this.eventStore.onPointerUpInNodeflow.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>{e.stopPropagation(),e.preventDefault()}},{name:"nodeflow:reset-mouse-data",event:({event:e})=>{this.mouseData.pointerDown=!1,this.mouseData.selectionBox.boundingBox=void 0,this.mouseData.heldMouseButtons.delete(e.button),this.mouseData.heldConnectors.length===1&&this.mouseData.selections.clearNodes(),this.mouseData.selections.clearConnectors()}}]),this.eventStore.onTouchStartInNodeflow.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()},{name:"nodeflow:clear-held-keys",event:({event:e})=>{e.touches.length===1&&this.keyboardData.clearKeys()}},{name:"nodeflow:handle-pinch",event:({event:e})=>{const{touches:o}=e;if(o.length!==2)return;const{pageX:n,pageY:s}=e.touches[0],{pageX:i,pageY:r}=e.touches[1];this.pinchDistance=Math.hypot(n-i,s-r)}},{name:"nodeflow:update-mouse-data",event:({event:e})=>{const{touches:o}=e;if(o.length!==1)return;const n=o[0],s=h.fromEvent(n);this.mouseData.selections.clearNodes(),this.mouseData.update({pointerDown:!0,mousePosition:s,clickStartPosition:h.of(s.x/this.zoomLevel-this.position.x,s.y/this.zoomLevel-this.position.y)})}}]),this.eventStore.onTouchMoveInNodeflow.subscribeMultiple([{name:"nodeflow:handle-pinch",event:({event:e})=>{const{touches:o}=e;if(o.length!==2)return;const{pageX:n,pageY:s}=o[0],{pageX:i,pageY:r}=o[1],c=Math.hypot(n-i,s-r),a=h.of((n+i)/2,(s+r)/2);this.settings.canZoom&&this.updateZoom(c-this.pinchDistance,a),this.pinchDistance=c}},{name:"nodeflow:update-mouse-data",event:({event:e})=>{const{touches:o}=e;o.length===1&&this.mouseData.updateWithPrevious(n=>{const s=h.fromEvent(o[0]);return this.updateBackgroundPosition(s.subtract(n.mousePosition)),{mousePosition:s}})}}]),this.eventStore.onKeyUpInNodeflow.subscribeMultiple([{name:"nodeflow:remove-held-key",event:({event:e})=>this.keyboardData.releaseKey(e.code)}]),this.eventStore.onKeyDownInNodeflow.subscribeMultiple([{name:"nodeflow:add-held-key",event:({event:e})=>this.keyboardData.pressKey(e.code),priority:10},{name:"nodeflow:handle-controls",event:({event:e})=>{switch(e.code){case y.DELETE:if(this.mouseData.heldNodes.length>0&&this.settings.canDeleteNodes){const o=k.evaluateHistoryGroup();this.mouseData.heldNodes.forEach(n=>this.removeNode(n.id,o))}else if(this.mouseData.heldConnections.length>0&&this.settings.canDeleteConnections){const o=k.evaluateHistoryGroup();this.mouseData.heldConnections.forEach(n=>this.removeConnection(n.connection.sourceConnector.parentNode.id,n.connection.sourceConnector.id,n.connection.destinationConnector.parentSection.parentNode.id,n.connection.destinationConnector.id,o))}break;case y.ESCAPE:this.mouseData.clearSelections();break;case y.SPACE:this.settings.debugMode&&(this.mouseData.selections.size>0?console.log(this.mouseData.selections):console.log(this.nodes));break;case y.EQUAL:case y.MINUS:if(e.ctrlKey){if(!this.settings.canZoom)return;e.preventDefault(),this.updateZoom(this.settings.keyboardZoomMultiplier*(e.code===y.EQUAL?1:-1),this.size.divideBy(2))}break;case y.KEY_Z:if(!e.ctrlKey)break;e.preventDefault(),e.shiftKey?this.changes.redo():this.changes.undo();break;case y.KEY_A:case y.KEY_S:case y.KEY_D:case y.KEY_W:case y.ARROW_UP:case y.ARROW_DOWN:case y.ARROW_LEFT:case y.ARROW_RIGHT:this.intervalId||(this.intervalId=setInterval(()=>this.handleMovement(),10))}}}]),this.eventStore.onWheelInNodeflow.subscribeMultiple([{name:"nodeflow:update-zoom",event:({event:e})=>{this.settings.canZoom&&this.updateZoom(-e.deltaY,h.fromEvent(e))}},{name:"nodeflow:prevent-scroll",event:({event:e})=>{e.preventDefault()}}]),this.eventStore.onMouseDownInNodeflow.subscribeMultiple([{name:"nodeflow:reset-movement",event:({event:e})=>{e.button===K.LEFT&&this.resetMovement()}},{name:"nodeflow:reset-mouse-data",event:({event:e})=>{e.button===K.LEFT&&this.mouseData.clearSelections(),this.mouseData.selectNodeflow(),this.mouseData.heldMouseButtons.add(e.button),this.mouseData.update({clickStartPosition:h.of(e.clientX/this.zoomLevel-this.position.x,e.clientY/this.zoomLevel-this.position.y),mousePosition:h.fromEvent(e)})}},{name:"nodeflow:create-selection-box",event:({event:e})=>{e.button!==K.LEFT||!this.keyboardData.isActionPressed(this.keymap.CREATE_SELECTION_BOX)||(this.mouseData.selectionBox.boundingBox=B.of(h.fromEvent(e),h.zero()))}},{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()}]),this.eventStore.onMouseDownInConnector.blacklist("nodeflow:allow-pan",(e,o)=>e.event.button!==K.LEFT&&o.startsWith("nodeflow")),this.eventStore.onMouseDownInConnector.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()},{name:"nodeflow:handle-click",event:({event:e})=>{this.mouseData.heldMouseButtons.add(e.button)}},{name:"nodeflow:start-creating-connection",event:({event:e,nodeId:o,connectorId:n})=>{this.mouseData.startCreatingConnection(o,h.fromEvent(e),n)}}]),this.eventStore.onTouchStartInConnector.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()},{name:"nodeflow:start-creating-connection",event:({event:e,nodeId:o,connectorId:n})=>{const{clientX:s,clientY:i}=e.touches[0];this.mouseData.startCreatingConnection(o,h.of(s,i),n)}}]),this.eventStore.onPointerUpInConnector.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>{e.preventDefault(),e.stopPropagation()},priority:2},{name:"nodeflow:connect-held-nodes",event:({event:e,nodeId:o,connectorId:n})=>{if(!this.settings.canCreateConnections||this.mouseData.heldConnectors.length!==1)return;const s=this.mouseData.heldConnectors[0],i=s?.parentNode;!s||!i||this.eventStore.onNodeConnected.publish({outputNodeId:i.id,outputId:s.id,inputNodeId:o,inputId:n,event:e})},priority:2},{name:"nodeflow:reset-mouse-data",event:()=>{this.mouseData.pointerDown=!1},priority:1}]),this.eventStore.onMouseDownInNode.blacklist("nodeflow:allow-pan",(e,o)=>e.event.button!==K.LEFT&&o.startsWith("nodeflow")),this.eventStore.onMouseDownInNode.subscribeMultiple([{name:"nodeflow:select-node",event:({event:e,nodeId:o})=>{this.keyboardData.isActionPressed(this.keymap.SELECT_MULTIPLE)||this.mouseData.clearSelections(),this.mouseData.selectNode(o,h.fromEvent(e),this.settings.canMoveNodes)}},{name:"nodeflow:handle-click",event:({event:e})=>{this.mouseData.heldMouseButtons.add(e.button)}},{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()}]),this.eventStore.onTouchStartInNode.subscribeMultiple([{name:"nodeflow:select-node",event:({event:e,nodeId:o})=>{const{clientX:n,clientY:s}=e.touches[0];this.keyboardData.isActionPressed(this.keymap.SELECT_MULTIPLE)||this.mouseData.clearSelections(),this.mouseData.selectNode(o,h.of(n,s),this.settings.canMoveNodes)}},{name:"nodeflow:stop-propagation",event:({event:e})=>e.stopPropagation()}]),this.eventStore.onPointerDownInNodeCurve.blacklist("nodeflow:allow-pan",(e,o)=>e.event.button!==K.LEFT&&o.startsWith("nodeflow")),this.eventStore.onPointerDownInNodeCurve.subscribeMultiple([{name:"nodeflow:stop-propagation",event:({event:e})=>{e.preventDefault(),e.stopPropagation()},priority:1},{name:"nodeflow:handle-click",event:({event:e})=>{this.mouseData.heldMouseButtons.add(e.button)}},{name:"nodeflow:update-mouse-data",event:({event:e,sourceConnector:o,destinationConnector:n})=>{this.mouseData.pointerDown=!0,this.mouseData.mousePosition=h.fromEvent(e),this.keyboardData.isActionPressed(this.keymap.SELECT_MULTIPLE)||this.mouseData.clearSelections(),this.mouseData.selections.add({type:p.Connection,connection:{sourceConnector:o,destinationConnector:n}})}}]),this.eventStore.onPointerUpInNode.subscribeMultiple([{name:"nodeflow:reset-mouse-data",event:()=>{this.mouseData.pointerDown=!1,this.mouseData.heldConnectors.length===1&&this.mouseData.selections.clearNodes(),this.mouseData.selections.clearConnectors()}}])}selectNode(e,o){this.mouseData.selectNode(e,o??h.zero(),!1)}transformVec2ToCanvas(e){return e.subtract(this.startPosition).divideBy(this.zoomLevel).subtract(this.position)}};f(Nt,"DEFAULT_SETTINGS",{allowCollision:!1,canAddNodes:!0,canCreateConnections:!0,canDeleteConnections:!0,canDeleteNodes:!0,canMoveNodes:!0,canPan:!0,canZoom:!0,debugMode:!1,keyboardZoomMultiplier:15,maxMovementSpeed:15,maxZoom:200,minZoom:.02,movementAcceleration:1.5,movementDeceleration:.85,zoomMultiplier:.005});let fo=Nt;const[it,po]=de(h.of(window.innerWidth,window.innerHeight));fe(()=>{const t=()=>po(h.of(window.innerWidth,window.innerHeight));return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)});const go="_connection_1glcg_1",vo="_selectedConnection_1glcg_16",yo="_newConnection_1glcg_27",ye={connection:go,selectedConnection:vo,newConnection:yo},mo="_node_1kvvi_1",wo="_selectedNode_1kvvi_15",Co="_inputConnector_1kvvi_22",Do="_outputConnector_1kvvi_35",No="_inputsSection_1kvvi_48",So="_outputsSection_1kvvi_52",q={node:mo,selectedNode:wo,inputConnector:Co,outputConnector:Do,inputsSection:No,outputsSection:So},bo="_nodeflow_1ic3z_1",Io={nodeflow:bo};var Po=$("<div><p></p><p>");const Eo=t=>(()=>{var e=Po(),o=e.firstChild,n=o.nextSibling;return e.style.setProperty("padding","1rem"),e.style.setProperty("padding-left","2rem"),e.style.setProperty("pointer-events","none"),O(o,()=>t.node.position.x.toFixed(2)),O(n,()=>t.node.position.y.toFixed(2)),e})(),bt=(t,e=!1)=>{const o=crypto.randomUUID(),n=E.addNode({css:{normal:q.node,selected:q.selectedNode},position:t,display:Eo,centered:e},o),s=n.addConnectorSection({id:"inputs",css:q.inputsSection},o),i=n.addConnectorSection({id:"outputs",css:q.outputsSection},o),r=Math.random()*6;for(let a=0;a<r;a++)i.addConnector({css:q.outputConnector},o);const c=Math.random()*6;for(let a=0;a<c;a++)s.addConnector({css:q.inputConnector},o);return n},Mo=()=>{E.eventStore.onNodeConnected.subscribe("nodeflow:create-connection",({outputNodeId:t,inputNodeId:e,outputId:o,inputId:n})=>{if(t===e)return;const s=E.nodes.get(e),i=E.nodes.get(t),r=s.connectorSections.get("inputs").connectors,c=i.connectorSections.get("outputs").connectors;!r.has(n)||!c.has(o)||r.get(n).sources.length>0||E.addConnection({sourceNodeId:t,sourceConnectorId:o,destinationNodeId:e,destinationConnectorId:n,css:{normal:ye.connection,selected:ye.selectedConnection}})})},xo=(t=50)=>{for(let e=0;e<t;e++)bt(h.of(Math.random()*2e3,Math.random()*2e3))},Ao=()=>{const t=E.nodes.size;for(let e=0;e<t;e++){const o=Math.floor(Math.random()*t),n=Math.floor(Math.random()*t);if(!E.nodes.has(o.toString())||!E.nodes.has(n.toString()))continue;const s=E.nodes.get(o.toString()),i=E.nodes.get(n.toString()),r=s.connectorSections.get("outputs").connectors,c=i.connectorSections.get("inputs").connectors,a=Array.from(r.values()),d=Array.from(c.values());if(a.length===0||d.length===0)continue;const u=a[Math.floor(Math.random()*a.length)],l=d[Math.floor(Math.random()*d.length)];o===n||i.getTotalConnectedInputs(l.toString())>0||E.addConnection({sourceNodeId:o.toString(),sourceConnectorId:u.id,destinationNodeId:n.toString(),destinationConnectorId:l.id,css:{normal:ye.connection,selected:ye.selectedConnection}})}};class zo extends wt{calculateCurveAnchors(e,o,n,s){const i=this.getHorizontalCurve(e,o),r=e.add(i),c=o.subtract(i);return{anchorStart:r,anchorEnd:c}}}var ko=$("<div>"),Oo=$("<div><div><div>Generic node");const[E,To]=N.get().createCanvas("main",{},t=>new zo(t)),Lo=()=>{const[t,e]=de(void 0),o=n=>{if(!t())return;e(void 0);const s=h.fromEvent(n.event),i=E.startPosition,r=E.size;if(!s.isWithinRect(i,r))return;const c=s.subtract(i).divideBy(E.zoomLevel).subtract(E.position);bt(c,!0)};return Mt(()=>{Mo(),xo(),Ao(),N.get().globalEventStore.onPointerUpInDocument.subscribe("create-node",o)}),(()=>{var n=Oo(),s=n.firstChild,i=s.firstChild;return n.style.setProperty("display","flex"),n.style.setProperty("flex-direction","column-reverse"),O(n,I(To,{get css(){return{getNewCurveCss:()=>ye.newConnection,nodeflow:Io.nodeflow}},height:"100%",width:"100%"}),s),s.style.setProperty("width","100%"),s.style.setProperty("min-height","300px"),s.style.setProperty("background-color","gray"),s.style.setProperty("opacity","0.5"),s.style.setProperty("display","flex"),s.style.setProperty("align-items","center"),s.style.setProperty("justify-content","center"),s.style.setProperty("gap","20px"),i.$$pointerdown=()=>{e("Generic node")},i.style.setProperty("width","150px"),i.style.setProperty("height","90px"),i.style.setProperty("display","flex"),i.style.setProperty("align-items","center"),i.style.setProperty("justify-content","center"),i.style.setProperty("user-select","none"),i.style.setProperty("cursor","grab"),O(n,I(ge,{get when(){return t()},get children(){var r=ko();return r.style.setProperty("position","absolute"),r.style.setProperty("width","150px"),r.style.setProperty("height","90px"),r.style.setProperty("display","flex"),r.style.setProperty("align-items","center"),r.style.setProperty("justify-content","center"),r.style.setProperty("z-index","1000"),r.style.setProperty("user-select","none"),r.style.setProperty("cursor","grabbing"),O(r,t),x(c=>{var a=`${E.mouseData.mousePosition.x-75}px`,d=`${E.mouseData.mousePosition.y-45}px`,u=q.node;return a!==c.e&&((c.e=a)!=null?r.style.setProperty("left",a):r.style.removeProperty("left")),d!==c.t&&((c.t=d)!=null?r.style.setProperty("top",d):r.style.removeProperty("top")),u!==c.a&&xe(r,c.a=u),c},{e:void 0,t:void 0,a:void 0}),r}}),null),x(r=>{var c=`${it().x}px`,a=`${it().y}px`,d=q.node;return c!==r.e&&((r.e=c)!=null?n.style.setProperty("width",c):n.style.removeProperty("width")),a!==r.t&&((r.t=a)!=null?n.style.setProperty("height",a):n.style.removeProperty("height")),d!==r.a&&xe(i,r.a=d),r},{e:void 0,t:void 0,a:void 0}),n})()};we(["pointerdown"]);const _o=document.getElementById("root");$t(()=>I(Lo,{}),_o);
